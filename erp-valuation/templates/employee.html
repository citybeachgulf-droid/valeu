{% extends 'base.html' %}
{% from 'partials/nav.html' import app_nav %}
{% set title = 'لوحة الموظف' %}

{% block head_extra %}
  <style>
    .employee-tabs .nav-link {
      border-radius: var(--app-radius-sm);
      padding: 0.6rem 1.25rem;
      color: var(--app-muted-strong);
      background: transparent;
      transition: all 0.2s ease;
    }
    .employee-tabs .nav-link.active {
      background: var(--app-primary);
      color: #fff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.18);
    }
    .employee-tabs .nav-link:not(.active):hover {
      background: rgba(37, 99, 235, 0.08);
      color: var(--app-primary);
    }
    .employee-section-divider {
      border-top: 1px dashed rgba(15, 23, 42, 0.12);
      margin: 1.5rem 0 1rem;
      padding-top: 1rem;
    }
  </style>
{% endblock %}

{% block navbar %}
  {{ app_nav(
      brand='لوحة الموظف',
      brand_url=url_for('employee_dashboard'),
      appearance='dark',
      items=[
        {'label': 'الرئيسية', 'href': url_for('employee_dashboard'), 'active': request.endpoint == 'employee_dashboard'},
        {'label': 'العملاء', 'href': url_for('customers_page')},
        {'label': 'التقارير', 'href': url_for('reports')}
      ],
      actions=[
        {'label': 'تسجيل الخروج', 'href': url_for('logout'), 'variant': 'outline-light'}
      ]
  ) }}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>مرحبًا بك في لوحة الموظف</h1>
  <div class="app-page-title__meta">
    <span>سجل معاملات العملاء وارفع مستندات البنوك والفروع من مكان واحد.</span>
    <span class="pill">معاملات العقار: {{ real_estate_brought_count }}</span>
    <span class="pill">معاملات المركبات: {{ vehicle_brought_count }}</span>
  </div>
</div>

<div class="stats-row" data-aos="fade-up" data-aos-delay="90">
  <div class="stat-card">
    <span class="stat-card__label">معاملات عقارية جُلبت بواسطة حسابك</span>
    <span class="stat-card__value">{{ real_estate_brought_count }}</span>
    <div class="text-muted small">تعتمد على نطاق التاريخ المحدد في التصفية.</div>
  </div>
  <div class="stat-card">
    <span class="stat-card__label">معاملات مركبات جُلبت بواسطة حسابك</span>
    <span class="stat-card__value">{{ vehicle_brought_count }}</span>
    <div class="text-muted small">حدّث البيانات بتغيير فترة التصفية.</div>
  </div>
</div>

<div class="app-card mt-4" data-aos="fade-up" data-aos-delay="120">
  <div class="app-card__header">
    <div>
      <h3 class="app-card__title">تصفية الفترة الزمنية</h3>
      <p class="app-card__subtitle mb-0">اختر تاريخ البداية والنهاية لتحديث الأرقام أعلاه.</p>
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('employee_dashboard') }}">إعادة التعيين</a>
  </div>
  <form method="GET" class="row g-3">
    <div class="col-12 col-md-4">
      <label class="form-label">من تاريخ</label>
      <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">إلى تاريخ</label>
      <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
    </div>
    <div class="col-12 col-md-4 d-flex align-items-end">
      <button class="btn btn-primary w-100">تطبيق التصفية</button>
    </div>
  </form>
</div>

<div class="app-card mt-4" data-aos="fade-up" data-aos-delay="150">
  <div class="app-card__header">
    <div>
      <h3 class="app-card__title">إدارة المعاملات والمستندات</h3>
      <p class="app-card__subtitle mb-0">استخدم التبويبات للاختيار بين تسجيل معاملة جديدة أو رفع مستند.</p>
    </div>
  </div>

  <ul class="nav nav-pills employee-tabs justify-content-center" id="employeeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-transaction-tab" data-bs-toggle="tab" data-bs-target="#tab-transaction" type="button" role="tab">تسجيل معاملة</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-bankdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-bankdocs" type="button" role="tab">مستندات البنوك</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-branchdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-branchdocs" type="button" role="tab">مستندات الفرع</button>
    </li>
  </ul>

  <div class="tab-content pt-4">
    <div class="tab-pane fade show active" id="tab-transaction" role="tabpanel" tabindex="0">
      <form method="POST" action="{{ url_for('add_transaction') }}" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">اسم العميل</label>
          <input type="text" name="client_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">رقم جوال العميل</label>
          <input type="text" name="client_phone" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">نوع المعاملة</label>
          <select name="transaction_type" id="transaction_type" class="form-select" required>
            <option value="">اختر نوع المعاملة</option>
            <option value="real_estate">تقييم عقاري</option>
            <option value="vehicle">تقييم مركبة</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">البنك المحيل</label>
          <select name="bank_id" class="form-select" required>
            <option value="">اختر البنك</option>
            {% for bank in banks %}
              <option value="{{ bank.id }}">{{ bank.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">فرع البنك</label>
          <input type="text" name="bank_branch" class="form-control" placeholder="اسم الفرع أو المدينة" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">اسم موظف البنك (إن وجد)</label>
          <input type="text" name="bank_employee_name" class="form-control">
        </div>

        <div class="col-md-6">
          <label class="form-label">المسوّق الذي جلب المعاملة</label>
          <input type="text" name="brought_by" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">الموظف المستلم للمعاملة</label>
          <input type="text" name="visited_by" class="form-control" required>
        </div>

        <div id="real_estate_fields" class="employee-section-divider" style="display:none;">
          <h6 class="fw-semibold mb-3">تفاصيل التقييم العقاري</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">المنطقة</label>
              <input type="text" name="state" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">المدينة / الحي</label>
              <input type="text" name="region" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">المساحة (م²)</label>
              <input type="number" step="0.01" name="area" id="area" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">سعر المتر (يُحدّث لاحقًا)</label>
              <input type="number" step="0.01" name="price_per_meter" id="price_per_meter" class="form-control" readonly>
            </div>
          </div>
        </div>

        <div id="vehicle_fields" class="employee-section-divider" style="display:none;">
          <h6 class="fw-semibold mb-3">تفاصيل التقييم للمركبات</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">نوع المركبة</label>
              <input type="text" name="vehicle_type" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">الموديل / الطراز</label>
              <input type="text" name="vehicle_model" class="form-control">
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">أتعاب التقييم (اختياري)</label>
          <input type="number" step="0.01" name="fee" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">مرفقات المعاملة</label>
          <input type="file" name="files" class="form-control" multiple>
        </div>

        <div id="estimate_box" class="alert alert-info mt-2" style="display:none;">
          <p class="mb-1 fw-semibold">تقدير قيمة المعاملة</p>
          <div class="small text-muted">يظهر بعد إدخال تفاصيل التقييم العقاري.</div>
          <div class="d-flex flex-column gap-1 mt-2">
            <span>قيمة الأرض: <strong id="land_value">0</strong> ر.س</span>
            <span>قيمة المبنى: <strong id="building_value">0</strong> ر.س</span>
            <span>الإجمالي التقديري: <strong id="total_estimate">0</strong> ر.س</span>
          </div>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100">تسجيل المعاملة</button>
        </div>
      </form>
    </div>

    <div class="tab-pane fade" id="tab-bankdocs" role="tabpanel" tabindex="0">
      <div class="row g-3">
        <div class="col-12">
          <p class="text-muted mb-3">ارفع مستندات البنوك المرتبطة بمعاملاتك أو التقييمات الحالية.</p>
        </div>
        <form class="row g-3" method="POST" action="{{ url_for('employee_add_bank_document') }}" enctype="multipart/form-data">
          <div class="col-md-4">
            <label class="form-label">اختر البنك</label>
            <select name="bank_id" class="form-select" required>
              <option value="">حدد البنك</option>
              {% for bank in banks %}
                <option value="{{ bank.id }}">{{ bank.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">عنوان المستند</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <div class="col-md-8">
            <label class="form-label">المستند</label>
            <input type="file" name="file" class="form-control">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100">رفع المستند</button>
          </div>
        </form>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-branchdocs" role="tabpanel" tabindex="0">
      <div class="row g-3">
        <div class="col-12">
          <p class="text-muted mb-3">إدارة مستندات الفرع الحالي ومتابعة صلاحيتها.</p>
        </div>
        <form method="POST" action="{{ url_for('employee_add_branch_document') }}" enctype="multipart/form-data" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">عنوان المستند</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">نوع المستند</label>
            <input type="text" name="doc_type" class="form-control" placeholder="مثل: ترخيص، عقد، خطاب...">
          </div>
          <div class="col-md-2">
            <label class="form-label">تاريخ الإصدار</label>
            <input type="date" name="issued_at" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">تاريخ الانتهاء</label>
            <input type="date" name="expires_at" class="form-control">
          </div>
          <div class="col-md-10">
            <label class="form-label">ملف المستند</label>
            <input type="file" name="file" class="form-control">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-success w-100">حفظ المستند</button>
          </div>
        </form>

        {% if docs %}
        <div class="col-12 mt-4">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>المستند</th>
                  <th>النوع</th>
                  <th>تاريخ الإصدار</th>
                  <th>تاريخ الانتهاء</th>
                  <th>الحالة</th>
                  <th class="text-end">ملف</th>
                </tr>
              </thead>
              <tbody>
                {% for doc in docs %}
                {% set status = status_for(doc) %}
                <tr>
                  <td class="fw-semibold">{{ doc.title }}</td>
                  <td>{{ doc.doc_type or 'غير محدد' }}</td>
                  <td>{{ doc.issued_at.strftime('%Y-%m-%d') if doc.issued_at else '—' }}</td>
                  <td>{{ doc.expires_at.strftime('%Y-%m-%d') if doc.expires_at else '—' }}</td>
                  <td>
                    <span class="status-chip
                      {% if status == 'منتهي' %}status-chip--danger{% elif status == 'قارب على الانتهاء' %}status-chip--warning{% else %}status-chip--success{% endif %}">
                      {{ status }}
                    </span>
                  </td>
                  <td class="text-end">
                    {% if doc.b2_file_name %}
                      <a class="btn btn-sm btn-outline-secondary" href="{{ build_b2_public_url(doc.b2_file_name) }}" target="_blank">عرض</a>
                    {% elif doc.file %}
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('download_local_file', filename=doc.file) }}">تحميل</a>
                    {% else %}
                      <span class="text-muted">لا يوجد ملف</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
        <div class="col-12">
          <div class="empty-state">
            <h4>لا توجد مستندات مسجلة حتى الآن</h4>
            <p>عند رفع المستندات سيظهر هنا ملخصها مع حالة الصلاحية.</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if transactions %}
<div class="app-card mt-4" data-aos="fade-up" data-aos-delay="180">
  <div class="app-card__header">
    <div>
      <h3 class="app-card__title">أحدث المعاملات المسندة إليك</h3>
      <p class="app-card__subtitle mb-0">عرض سريع لآخر خمس معاملات مرتبطة بحسابك.</p>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>العميل</th>
          <th>نوع المعاملة</th>
          <th>البنك</th>
          <th>التاريخ</th>
          <th>الحالة</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions[:5] %}
        {% if t.status == 'Completed' %}
          {% set status_class = 'status-chip--success' %}
          {% set status_label = 'منتهية' %}
        {% elif t.status == 'In Progress' %}
          {% set status_class = 'status-chip--info' %}
          {% set status_label = 'قيد التنفيذ' %}
        {% elif t.status == 'Pending' %}
          {% set status_class = 'status-chip--warning' %}
          {% set status_label = 'قيد المراجعة' %}
        {% elif t.status == 'Cancelled' %}
          {% set status_class = 'status-chip--danger' %}
          {% set status_label = 'ملغاة' %}
        {% else %}
          {% set status_class = 'status-chip--info' %}
          {% set status_label = t.status or 'غير محدد' %}
        {% endif %}
        <tr>
          <td>{{ t.id }}</td>
          <td>{{ t.client }}</td>
          <td>{{ 'تقييم عقاري' if t.transaction_type == 'real_estate' else 'تقييم مركبة' }}</td>
          <td>{{ t.bank.name if t.bank else 'غير محدد' }}</td>
          <td>{{ t.date.strftime('%Y-%m-%d') if t.date else '—' }}</td>
          <td><span class="status-chip {{ status_class }}">{{ status_label }}</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const typeSelect = document.getElementById('transaction_type');
    const realFields = document.getElementById('real_estate_fields');
    const vehicleFields = document.getElementById('vehicle_fields');
    const estimateBox = document.getElementById('estimate_box');
    const realRequiredNames = ['state', 'region', 'area'];

    const toggleTypeFields = () => {
      if (!typeSelect) {
        return;
      }
      const val = typeSelect.value;
      const isRealEstate = val === 'real_estate';
      if (realFields) {
        realFields.style.display = isRealEstate ? 'block' : 'none';
      }
      if (vehicleFields) {
        vehicleFields.style.display = val === 'vehicle' ? 'block' : 'none';
      }
      if (estimateBox) {
        estimateBox.style.display = isRealEstate ? 'block' : 'none';
      }
      realRequiredNames.forEach((name) => {
        const field = document.querySelector(`[name=\"${name}\"]`);
        if (field) {
          if (isRealEstate) {
            field.setAttribute('required', 'required');
          } else {
            field.removeAttribute('required');
          }
        }
      });
    };

    if (typeSelect) {
      typeSelect.addEventListener('change', toggleTypeFields);
      toggleTypeFields();
    }
  });
</script>
{% endblock %}
