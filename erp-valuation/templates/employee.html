{% extends 'base.html' %}
{% set title = 'ğŸ—ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù' %}

{% block head_extra %}
  <style>
    .navbar-brand { font-weight: bold; }
    .card { border-radius: 15px; }
    h2, h5 { font-weight: bold; }
    .form-label { font-weight: 500; }
    .alert-info { border-radius: 12px; }
  </style>
{% endblock %}

{% block navbar %}
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm animate__animated animate__fadeInDown">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ğŸ› ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('employee_dashboard') }}">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('customers_page') }}">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
          <li class="nav-item"><a class="nav-link text-warning" href="/reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
        </ul>
      </div>
    </div>
  </nav>
{% endblock %}

{% block content %}
  <div class="container mt-5">
    <h2 class="text-center mb-5" data-aos="fade-up">ğŸ“Œ Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <form method="GET" class="row g-2 mb-3">
      <div class="col-12 col-md-3">
        <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
      </div>
      <div class="col-12 col-md-3 d-flex align-items-end">
        <button class="btn btn-outline-primary w-100">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø©</button>
      </div>
      <div class="col-12 col-md-3 d-flex align-items-end">
        <a class="btn btn-outline-secondary w-100" href="{{ url_for('employee_dashboard') }}">Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±</a>
      </div>
    </form>
    <div class="row mb-3">
      <div class="col-md-6 mb-2">
        <div class="alert alert-secondary">
          ğŸ  Ø¹Ø¯Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„ØªÙŠ Ø¬Ù„Ø¨ØªÙ‡Ø§: <strong>{{ real_estate_brought_count }}</strong>
        </div>
      </div>
      <div class="col-md-6 mb-2">
        <div class="alert alert-secondary">
          ğŸš— Ø¹Ø¯Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„ØªÙŠ Ø¬Ù„Ø¨ØªÙ‡Ø§: <strong>{{ vehicle_brought_count }}</strong>
        </div>
      </div>
    </div>
    
    <!-- âœ… Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù†Ø³Ù‘Ù‚Ø©: ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø«Ù„Ø§Ø« -->
    <ul class="nav nav-pills justify-content-center mb-4" id="employeeTabs" role="tablist" data-aos="zoom-in">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-transaction-tab" data-bs-toggle="tab" data-bs-target="#tab-transaction" type="button" role="tab">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-bankdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-bankdocs" type="button" role="tab">ğŸ¦ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø¨Ù†Ùƒ</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-branchdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-branchdocs" type="button" role="tab">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø´Ø±ÙƒØ©</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© -->
      <div class="tab-pane fade show active" id="tab-transaction" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-md-8" data-aos="fade-up">
            <div class="card shadow-lg p-4">
              <h5 class="mb-4">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
              <form method="POST" action="{{ url_for('add_transaction') }}" enctype="multipart/form-data">
                <div class="mb-3">
                  <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" name="client_name" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" name="client_phone" class="form-control" placeholder=" " required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ“‚ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                  <select name="transaction_type" id="transaction_type" class="form-select" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ --</option>
                    <option value="real_estate">ğŸ  Ø¹Ù‚Ø§Ø±</option>
                    <option value="vehicle">ğŸš— Ù…Ø±ÙƒØ¨Ø©</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ</label>
                  <select name="bank_id" class="form-select" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ --</option>
                    {% for bank in banks %}
                      <option value="{{ bank.id }}">{{ bank.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ¦ ÙØ±Ø¹ Ø§Ù„Ø¨Ù†Ùƒ</label>
                  <input type="text" name="bank_branch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙØ±Ø¹ Ø§Ù„Ø¨Ù†Ùƒ" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="text" name="bank_employee_name" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ù†Ùƒ Ø¥Ù† ÙˆØ¬Ø¯">
                </div>
                <!-- ğŸ†• Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø© -->
                <div class="mb-3">
                  <label class="form-label">Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ</label>
                  <input type="text" name="brought_by" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ</label>
                  <input type="text" name="visited_by" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø²ÙŠØ§Ø±Ø©">
                </div>
                <div id="real_estate_fields" style="display:none;">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                      <input type="text" name="state" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                      <input type="text" name="region" class="form-control" required>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)</label>
                      <input type="number" step="0.01" name="area" id="area" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ù‚ØªØ±Ø­</label>
                      <div class="input-group">
                        <input type="number" step="0.01" name="price_per_meter" id="price_per_meter" class="form-control" placeholder="ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù† ÙˆÙØ¬Ø¯" readonly>
                        <span class="input-group-text">Ø±ÙŠØ§Ù„/Ù…Â²</span>
                      </div>
                    </div>
                  </div>
                  <h6 class="mt-3">ğŸ—ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§Ø¡</h6>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ù…Â²)</label>
                      <input type="number" step="0.01" name="building_area" id="building_area" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø¹Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª)</label>
                      <input type="number" name="building_age" id="building_age" class="form-control">
                    </div>
                  </div>
                </div>
                <div id="vehicle_fields" style="display:none;">
                  <div class="mb-3">
                    <label class="form-label">ğŸš˜ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
                    <input type="text" name="vehicle_type" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                    <input type="text" name="vehicle_model" class="form-control">
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label>
                      <input type="number" name="vehicle_year" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
                      <input type="number" step="0.01" name="vehicle_value" class="form-control">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ’µ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                  <input type="number" step="0.01" name="fee" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">ğŸ“ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                  <input type="file" name="files" class="form-control" multiple>
                </div>
                <div id="estimate_box" class="alert alert-info" style="display:none;">
                  <b>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø£Ø±Ø¶:</b> <span id="land_value">0</span> Ø±ÙŠØ§Ù„ <br>
                  <b>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø¨Ù†Ø§Ø¡:</b> <span id="building_value">0</span> Ø±ÙŠØ§Ù„ <br>
                  <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> <span id="total_estimate">0</span> Ø±ÙŠØ§Ù„
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-3">ğŸš€ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø¨Ù†Ùƒ -->
      <div class="tab-pane fade" id="tab-bankdocs" role="tabpanel">
        <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆØ§Ù„Ø§ÙƒØªÙØ§Ø¡ Ø¨Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡. -->

        <div class="row justify-content-center mt-3">
          <div class="col-md-8" data-aos="fade-up">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="mb-3">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©/Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© Ù„Ù„Ø¨Ù†Ùƒ (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§Ù…Ù„Ø©)</h5>
                <form class="row g-2" method="POST" action="{{ url_for('employee_add_bank_document') }}" enctype="multipart/form-data">
                  <div class="col-md-4">
                    <label class="form-label">ğŸ¦ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ</label>
                    <select name="bank_id" class="form-select" required>
                      <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ â€”</option>
                      {% for bank in banks %}
                        <option value="{{ bank.id }}">{{ bank.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                    <input type="text" name="title" class="form-control" placeholder="" required>
                  </div>
                 
                
                  <div class="col-md-8">
                    <label class="form-label">Ù…Ù„Ù Ù…Ø±ÙÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="file" name="file" class="form-control">
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary w-100">Ø¥Ø±Ø³Ø§Ù„</button>
                  </div>
                </form>
                <div class="form-text">ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø±Ø³Ø§Ø¦Ù„/Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¹Ø§Ù…Ø©" ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ù†Ùƒ.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©/Ø§Ù„ÙØ±Ø¹ -->
      <div class="tab-pane fade" id="tab-branchdocs" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-md-10" data-aos="fade-up">
            <div class="card shadow-lg p-4">
              <h5 class="mb-3">ğŸ“ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©/Ø§Ù„ÙØ±Ø¹</h5>
              <form method="POST" action="{{ url_for('employee_add_branch_document') }}" enctype="multipart/form-data" class="mb-3">
                <div class="mb-2">
                  <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
                  <input type="text" name="title" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
                  <input type="text" name="doc_type" class="form-control" placeholder="Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠØŒ Ø¶Ø±ÙŠØ¨Ø©ØŒ ..">
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
                    <input type="date" name="issued_at" class="form-control">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                    <input type="date" name="expires_at" class="form-control">
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø§Ù„Ù…Ù„Ù</label>
                  <input type="file" name="file" class="form-control">
                </div>
                <button class="btn btn-success w-100">â¬†ï¸ Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</button>
              </form>

              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                      <th>Ø§Ù„Ù†ÙˆØ¹</th>
                      <th>Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                      <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th>Ø§Ù„Ù…Ù„Ù</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in docs or [] %}
                    <tr>
                      <td>{{ d.title }}</td>
                      <td>{{ d.doc_type or 'â€”' }}</td>
                      <td>{{ d.issued_at.strftime('%Y-%m-%d') if d.issued_at else 'â€”' }}</td>
                      <td>{{ d.expires_at.strftime('%Y-%m-%d') if d.expires_at else 'â€”' }}</td>
                      <td>
                        {% set s = status_for(d) %}
                        <span class="badge {% if s=='Ø³Ø§Ø±ÙŠ' %}bg-success{% elif s=='Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' %}bg-warning text-dark{% elif s=='Ù…Ù†ØªÙ‡ÙŠ' %}bg-danger{% else %}bg-secondary{% endif %}">{{ s }}</span>
                      </td>
                      <td>
                        {% if d.file %}
                          <a href="{{ url_for('uploaded_file', filename=d.file) }}" target="_blank">ÙØªØ­</a>
                        {% else %}
                          â€”
                        {% endif %}
                      </td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#editDoc{{ d.id }}">ØªØ¹Ø¯ÙŠÙ„</button>
                        <form method="POST" action="{{ url_for('employee_delete_branch_document', doc_id=d.id) }}" style="display:inline" onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ');">
                          <button class="btn btn-sm btn-outline-danger">Ø­Ø°Ù</button>
                        </form>
                      </td>
                    </tr>
                    <tr class="collapse" id="editDoc{{ d.id }}">
                      <td colspan="7">
                        <form method="POST" action="{{ url_for('employee_edit_branch_document', doc_id=d.id) }}" enctype="multipart/form-data" class="border rounded p-3 bg-light">
                          <div class="row g-2">
                            <div class="col-md-3">
                              <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                              <input type="text" name="title" class="form-control" value="{{ d.title }}" required>
                            </div>
                            <div class="col-md-3">
                              <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                              <input type="text" name="doc_type" class="form-control" value="{{ d.doc_type or '' }}">
                            </div>
                            <div class="col-md-3">
                              <label class="form-label">Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
                              <input type="date" name="issued_at" class="form-control" value="{{ d.issued_at.strftime('%Y-%m-%d') if d.issued_at else '' }}">
                            </div>
                            <div class="col-md-3">
                              <label class="form-label">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                              <input type="date" name="expires_at" class="form-control" value="{{ d.expires_at.strftime('%Y-%m-%d') if d.expires_at else '' }}">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù</label>
                              <input type="file" name="file" class="form-control">
                            </div>
                            <div class="col-md-6 d-flex align-items-end justify-content-end">
                              <button class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                            </div>
                          </div>
                        </form>
                      </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  // Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
  var __isUserEditing = false;
  var __updateBannerEl = null;
  function __setupEditingGuards(){
    try {
      var formEl = document.querySelector('form');
      var inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(function(el){
        el.addEventListener('focus', function(){ __isUserEditing = true; });
        el.addEventListener('input', function(){ __isUserEditing = true; });
        el.addEventListener('blur', function(){
          // Ø£Ù…Ù‡Ù„ Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø± Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
          setTimeout(function(){ __isUserEditing = false; }, 1000);
        });
      });
      if (formEl) {
        formEl.addEventListener('submit', function(){ __isUserEditing = false; });
      }
    } catch (_) {}
  }
  function __ensureUpdateBanner(){
    if (__updateBannerEl) return __updateBannerEl;
    var banner = document.createElement('div');
    banner.style.position = 'fixed';
    banner.style.bottom = '16px';
    banner.style.left = '50%';
    banner.style.transform = 'translateX(-50%)';
    banner.style.background = '#0d6efd';
    banner.style.color = '#fff';
    banner.style.padding = '10px 14px';
    banner.style.borderRadius = '8px';
    banner.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    banner.style.display = 'none';
    banner.style.zIndex = '2147483647';
    banner.innerHTML = 'Ø­Ø¯Ø« ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª. <button id="__doReloadBtn" style="margin-inline-start:8px" class="btn btn-light btn-sm">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>';
    document.body.appendChild(banner);
    var btn = banner.querySelector('#__doReloadBtn');
    if (btn) btn.addEventListener('click', function(){ location.reload(); });
    __updateBannerEl = banner;
    return banner;
  }
  // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±Ø§Ø³ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', __setupEditingGuards);
  function calculateEstimate() {
    let area            = parseFloat(document.getElementById("area")?.value) || 0;
    let price_per_meter = parseFloat(document.getElementById("price_per_meter")?.value) || 0;
    let building_area   = parseFloat(document.getElementById("building_area")?.value) || 0;
    let building_age    = parseInt(document.getElementById("building_age")?.value) || 0;

    let land_value = area * price_per_meter;
    let building_value = 0;
   if (building_area > 0 && building_age > 0) {
  building_value = building_area * 185 / 50 * (50 - building_age);
}


    let total_estimate = land_value + building_value;

    document.getElementById("land_value").innerText = land_value.toFixed(2);
    document.getElementById("building_value").innerText = building_value.toFixed(2);
    document.getElementById("total_estimate").innerText = total_estimate.toFixed(2);
  }

  function fetchPrice() {
    let stateEl  = document.querySelector("input[name='state']");
    let regionEl = document.querySelector("input[name='region']");
    let bankEl   = document.querySelector("select[name='bank_id']");
    if (!stateEl || !regionEl || !bankEl) return;

    let state   = stateEl.value;
    let region  = regionEl.value;
    let bank_id = bankEl.value;

    if (state && region && bank_id) {
      $.post("/get_price", { state, region, bank_id }, function(data) {
        if (data.price_per_meter !== undefined) {
          if (document.getElementById("price_per_meter")) {
            document.getElementById("price_per_meter").value = data.price_per_meter || 0;
          }
          calculateEstimate();
        }
      });
    }
  }

  // âœ… Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  function toggleTypeFields() {
    const type = document.getElementById("transaction_type")?.value || "";
    const real = document.getElementById("real_estate_fields");
    const veh  = document.getElementById("vehicle_fields");
    const box  = document.getElementById("estimate_box");

    if (real) real.style.display = (type === "real_estate") ? "block" : "none";
    if (veh)  veh.style.display  = (type === "vehicle")     ? "block" : "none";
    if (box)  box.style.display  = (type === "real_estate") ? "block" : "none";

    // ØªØ¹Ø·ÙŠÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ÙÙŠ Ù„ØªØ¬Ø§ÙˆØ² ØªØ­Ù‚Ù‚ required ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
    function setSectionDisabled(sectionEl, disabled) {
      if (!sectionEl) return;
      sectionEl.querySelectorAll("input, select, textarea").forEach(el => {
        el.disabled = disabled;
      });
    }

    setSectionDisabled(real, type !== "real_estate");
    setSectionDisabled(veh,  type !== "vehicle");
  }

  // ØªØºÙŠÙ‘Ø± Ø§Ù„Ù†ÙˆØ¹
  document.getElementById("transaction_type").addEventListener("change", function() {
    toggleTypeFields();              // âœ… Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±ÙŠ
    // Ù…Ø§ÙÙŠ Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ù…Ø±ÙƒØ¨Ø© Ù‡Ù†Ø§Ø› Ø§Ù„Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·
  });

  // Ù…Ø³ØªÙ…Ø¹Ùˆ Ø§Ù„Ø³Ø¹Ø± (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·)
  const stateInput  = document.querySelector("input[name='state']");
  const regionInput = document.querySelector("input[name='region']");
  const bankSelect  = document.querySelector("select[name='bank_id']");
  if (stateInput)  stateInput.addEventListener("input", fetchPrice);
  if (regionInput) regionInput.addEventListener("input", fetchPrice);
  if (bankSelect)  bankSelect.addEventListener("change", fetchPrice);

  // Ø£ÙŠ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)
  document.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", calculateEstimate);
  });

  // âœ… Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  toggleTypeFields();
  calculateEstimate();
  </script>

  <script>
  if ("serviceWorker" in navigator && "PushManager" in window) {
    navigator.serviceWorker.register("/service-worker.js")
      .then(function(reg) {
        console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„:", reg);
        if (Notification && Notification.permission !== "granted") {
          Notification.requestPermission().then(function() {
            subscribeUser().catch(console.error);
          });
        } else {
          subscribeUser().catch(console.error);
        }
      })
      .catch(function(err) { console.error("âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err); });
  }
  </script>

  <script>
  // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© PUSH Ù…Ù† Service Worker
  (function setupBeepListener(){
    if (!navigator.serviceWorker) return;
    navigator.serviceWorker.addEventListener("message", function(event){
      if (!event || !event.data || event.data.type !== "PUSH_NOTIFICATION") return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880; // Ù†ØºÙ…Ø© Ù‚ØµÙŠØ±Ø©
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
        o.start();
        o.stop(ctx.currentTime + 0.4);
      } catch (_){ /* ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ ØµÙˆØª */ }
    });
  })();

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ø¥Ù„Ù‰ Uint8Array
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function subscribeUser() {
    try {
      const registration = await navigator.serviceWorker.ready;
      const vapidPublicKey = "{{ vapid_public_key }}";
      const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
      const existing = await registration.pushManager.getSubscription();
      if (!existing) {
        const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
        await fetch("/save-subscription", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(subscription) });
      }
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", err);
    }
  }
  </script>
  <!-- ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
{% endblock %}


