{% extends 'base.html' %}
{% set title = '🏗️ لوحة الموظف' %}

{% block head_extra %}
  <style>
    /* --- الخطوط والألوان --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
    h2, h5, h6 { font-weight: 700; }
    .form-label { font-weight: 500; }
    .card { border-radius: 15px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
    .card:hover { transform: translateY(-4px); }
    .nav-pills .nav-link { border-radius: 50px; margin: 0 4px; }
    .alert-info { border-radius: 12px; background-color: #e7f1ff; color: #0d6efd; }
    .tab-content > .tab-pane { animation: fadeIn 0.5s ease-in-out; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* responsive tweaks */
    @media (max-width: 768px) {
      .card { padding: 15px; }
      .nav-pills { flex-wrap: wrap; justify-content: center; }
    }
  </style>
{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm animate__animated animate__fadeInDown">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">🛠️ نظام التثمين</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('employee_dashboard') }}">🏠 الصفحة الرئيسية</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('customers_page') }}">👥 العملاء</a></li>
        <li class="nav-item"><a class="nav-link text-warning" href="/reports">📑 التقارير</a></li>
        <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">🚪 تسجيل الخروج</a></li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-5">

  <!-- عنوان رئيسي -->
  <h2 class="text-center mb-5" data-aos="fade-up">📌 لوحة البيانات</h2>

  <!-- فلترة الفترة -->
  <form method="GET" class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <label class="form-label">من تاريخ</label>
      <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">إلى تاريخ</label>
      <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
    </div>
    <div class="col-12 col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-primary w-100">تطبيق الفترة</button>
    </div>
    <div class="col-12 col-md-3 d-flex align-items-end">
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('employee_dashboard') }}">مسح الفلتر</a>
    </div>
  </form>

  <!-- بطاقات الإحصائيات -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="alert alert-secondary shadow-sm rounded-3">
        🏠 عدد معاملات العقار التي جلبتها: <strong>{{ real_estate_brought_count }}</strong>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="alert alert-secondary shadow-sm rounded-3">
        🚗 عدد معاملات السيارة التي جلبتها: <strong>{{ vehicle_brought_count }}</strong>
      </div>
    </div>
  </div>

  <!-- تبويبات المهام -->
  <ul class="nav nav-pills justify-content-center mb-4" id="employeeTabs" role="tablist" data-aos="zoom-in">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-transaction-tab" data-bs-toggle="tab" data-bs-target="#tab-transaction" type="button" role="tab">➕ إضافة معاملة</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-bankdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-bankdocs" type="button" role="tab">🏦 إضافة مستندات للبنك</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-branchdocs-tab" data-bs-toggle="tab" data-bs-target="#tab-branchdocs" type="button" role="tab">📁 مستندات الشركة/الفرع</button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- تبويب إضافة معاملة -->
    <div class="tab-pane fade show active" id="tab-transaction" role="tabpanel">
      <div class="row justify-content-center">
        <div class="col-md-8" data-aos="fade-up">
          <div class="card p-4">
            <h5 class="mb-4">➕ إضافة معاملة جديدة</h5>
            <form method="POST" action="{{ url_for('add_transaction') }}" enctype="multipart/form-data">

              <!-- بيانات العميل -->
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">👤 اسم العميل</label>
                  <input type="text" name="client_name" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">📞 رقم العميل</label>
                  <input type="text" name="client_phone" class="form-control" required>
                </div>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label">📂 نوع المعاملة</label>
                  <select name="transaction_type" id="transaction_type" class="form-select" required>
                    <option value="">-- اختر النوع --</option>
                    <option value="real_estate">🏠 عقار</option>
                    <option value="vehicle">🚗 مركبة</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">🏦 البنك</label>
                  <select name="bank_id" class="form-select" required>
                    <option value="">-- اختر البنك --</option>
                    {% for bank in banks %}
                      <option value="{{ bank.id }}">{{ bank.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- معلومات إضافية -->
              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label">🏦 فرع البنك</label>
                  <input type="text" name="bank_branch" class="form-control" placeholder="اكتب اسم فرع البنك" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">👤 موظف البنك (اختياري)</label>
                  <input type="text" name="bank_employee_name" class="form-control">
                </div>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label">من جلب المعاملة؟</label>
                  <input type="text" name="brought_by" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">من قام بالزيارة؟</label>
                  <input type="text" name="visited_by" class="form-control" required>
                </div>
              </div>

              <!-- الحقول الديناميكية -->
              <div id="real_estate_fields" style="display:none;" class="mt-3 border-top pt-3">
                <h6>🏠 تفاصيل العقار</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">الولاية</label>
                    <input type="text" name="state" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">المنطقة</label>
                    <input type="text" name="region" class="form-control" required>
                  </div>
                </div>
                <div class="row g-3 mt-2">
                  <div class="col-md-6">
                    <label class="form-label">المساحة (م²)</label>
                    <input type="number" step="0.01" name="area" id="area" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">سعر المتر المقترح</label>
                    <input type="number" step="0.01" name="price_per_meter" id="price_per_meter" class="form-control" readonly>
                  </div>
                </div>
              </div>

              <div id="vehicle_fields" style="display:none;" class="mt-3 border-top pt-3">
                <h6>🚗 تفاصيل المركبة</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">نوع المركبة</label>
                    <input type="text" name="vehicle_type" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">الموديل</label>
                    <input type="text" name="vehicle_model" class="form-control">
                  </div>
                </div>
              </div>

              <!-- الملفات والرسوم -->
              <div class="row g-3 mt-3">
                <div class="col-md-6">
                  <label class="form-label">💵 رسوم المعاملة</label>
                  <input type="number" step="0.01" name="fee" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">📎 ملفات المعاملة</label>
                  <input type="file" name="files" class="form-control" multiple>
                </div>
              </div>

              <div id="estimate_box" class="alert alert-info mt-3" style="display:none;">
                <b>القيمة التقديرية للأرض:</b> <span id="land_value">0</span> ريال <br>
                <b>القيمة التقديرية للبناء:</b> <span id="building_value">0</span> ريال <br>
                <b>الإجمالي:</b> <span id="total_estimate">0</span> ريال
              </div>

              <button type="submit" class="btn btn-primary w-100 mt-3">🚀 حفظ المعاملة وإشعار المهندس</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- تبويب مستندات البنك -->
    <div class="tab-pane fade" id="tab-bankdocs" role="tabpanel">
      <div class="row justify-content-center mt-3">
        <div class="col-md-8" data-aos="fade-up">
          <div class="card p-3 shadow-sm">
            <h5 class="mb-3">✉️ إرسال رسالة/سيرة ذاتية للبنك (بدون معاملة)</h5>
            <form class="row g-2" method="POST" action="{{ url_for('employee_add_bank_document') }}" enctype="multipart/form-data">
              <div class="col-md-4">
                <label class="form-label">🏦 اختر البنك</label>
                <select name="bank_id" class="form-select" required>
                  <option value="">— اختر البنك —</option>
                  {% for bank in banks %}
                    <option value="{{ bank.id }}">{{ bank.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">العنوان</label>
                <input type="text" name="title" class="form-control" required>
              </div>
              <div class="col-md-8">
                <label class="form-label">ملف مرفق (اختياري)</label>
                <input type="file" name="file" class="form-control">
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100">إرسال</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- تبويب مستندات الفرع -->
    <div class="tab-pane fade" id="tab-branchdocs" role="tabpanel">
      <div class="row justify-content-center mt-3">
        <div class="col-md-10" data-aos="fade-up">
          <div class="card p-4 shadow-lg">
            <h5 class="mb-3">📁 مستندات الشركة/الفرع</h5>
            <!-- نموذج رفع مستند -->
            <form method="POST" action="{{ url_for('employee_add_branch_document') }}" enctype="multipart/form-data" class="mb-3">
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">عنوان المستند</label>
                  <input type="text" name="title" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">نوع المستند</label>
                  <input type="text" name="doc_type" class="form-control" placeholder="سجل تجاري، ضريبة، ..">
                </div>
                <div class="col-md-2">
                  <label class="form-label">تاريخ الإصدار</label>
                  <input type="date" name="issued_at" class="form-control">
                </div>
                <div class="col-md-2">
                  <label class="form-label">تاريخ الانتهاء</label>
                  <input type="date" name="expires_at" class="form-control">
                </div>
                <div class="col-md-10 mt-2">
                  <label class="form-label">الملف</label>
                  <input type="file" name="file" class="form-control">
                </div>
                <div class="col-md-2 mt-2 d-flex align-items-end">
                  <button class="btn btn-success w-100">⬆️ رفع المستند</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // إعادة استخدام الكود السابق للحقول الديناميكية والحساب التقديري
  const typeSelect = document.getElementById("transaction_type");
  const realFields = document.getElementById("real_estate_fields");
  const vehicleFields = document.getElementById("vehicle_fields");
  const estimateBox = document.getElementById("estimate_box");

  function toggleTypeFields() {
    const val = typeSelect.value;
    realFields.style.display = val === 'real_estate' ? 'block' : 'none';
    vehicleFields.style.display = val === 'vehicle' ? 'block' : 'none';
    estimateBox.style.display = val === 'real_estate' ? 'block' : 'none';
  }
  typeSelect.addEventListener('change', toggleTypeFields);
  toggleTypeFields();
</script>
{% endblock %}
