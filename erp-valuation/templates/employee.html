<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ—ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <style>
    body { background-color: #f8f9fa; font-family: "Tajawal", sans-serif; }
    .navbar-brand { font-weight: bold; }
    .card { border-radius: 15px; }
    h2, h5 { font-weight: bold; }
    .form-label { font-weight: 500; }
    .alert-info { border-radius: 12px; }
  </style>
</head>
<body>
  
  <!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ğŸ› ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('employee_dashboard') }}">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-warning" href="/reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-danger" href="{{ url_for('logout') }}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- âœ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <div class="container mt-5">
    <h2 class="text-center mb-5">ğŸ“Œ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h2>

    <div class="row justify-content-center">
      <!-- ğŸ“ Ù‚Ø³Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© -->
      <div class="col-md-7">
        <div class="card shadow-lg p-4">
          <h5 class="mb-4">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
          <form method="POST" action="{{ url_for('add_transaction') }}" enctype="multipart/form-data">
            
            <div class="mb-3">
              <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input type="text" name="client_name" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">ğŸ“‚ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
              <select name="transaction_type" id="transaction_type" class="form-select" required>
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ --</option>
                <option value="real_estate">ğŸ  Ø¹Ù‚Ø§Ø±</option>
                <option value="vehicle">ğŸš— Ù…Ø±ÙƒØ¨Ø©</option>
              </select>
            </div>

            <!-- âœ… Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± -->
            <div id="real_estate_fields" style="display:none;">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                  <input type="text" name="state" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                  <input type="text" name="region" class="form-control">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ</label>
                <select name="bank_id" class="form-select">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ --</option>
                    {% for bank in banks %}
                        <option value="{{ bank.id }}">{{ bank.name }}</option>
                    {% endfor %}
                </select>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)</label>
                  <input type="number" step="0.01" name="area" id="area" class="form-control">
                </div> <!-- âœ… ÙƒØ§Ù† Ù„Ø§Ø²Ù… ÙŠØªÙ‚ÙÙ„ -->
              </div>

              <h6 class="mt-3">ğŸ—ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§Ø¡</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ù…Â²)</label>
                  <input type="number" step="0.01" name="building_area" id="building_area" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ø¹Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª)</label>
                  <input type="number" name="building_age" id="building_age" class="form-control">
                </div>
              </div>
            </div>

            <!-- âœ… Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
            <div id="vehicle_fields" style="display:none;">
              <div class="mb-3">
                <label class="form-label">ğŸš˜ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
                <input type="text" name="vehicle_type" class="form-control">
              </div>
              <div class="mb-3">
                <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                <input type="text" name="vehicle_model" class="form-control">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label>
                  <input type="number" name="vehicle_year" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
                  <input type="number" step="0.01" name="vehicle_value" class="form-control">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">ğŸ’µ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
              <input type="number" step="0.01" name="fee" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">ğŸ“ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
              <input type="file" name="files" class="form-control" multiple>
            </div>

            <!-- ğŸ–© Ø¹Ø±Ø¶ Ø§Ù„ØªØ«Ù…ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø±) -->
            <div id="estimate_box" class="alert alert-info" style="display:none;">
              <b>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø£Ø±Ø¶:</b> <span id="land_value">0</span> Ø±ÙŠØ§Ù„ <br>
              <b>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø¨Ù†Ø§Ø¡:</b> <span id="building_value">0</span> Ø±ÙŠØ§Ù„ <br>
              <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> <span id="total_estimate">0</span> Ø±ÙŠØ§Ù„
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¯ÙŠØ±</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø­Ø³Ø§Ø¨ -->
  <script>
  function calculateEstimate() {
    let area            = parseFloat(document.getElementById("area")?.value) || 0;
    let price_per_meter = parseFloat(document.getElementById("price_per_meter")?.value) || 0;
    let building_area   = parseFloat(document.getElementById("building_area")?.value) || 0;
    let building_age    = parseInt(document.getElementById("building_age")?.value) || 0;

    let land_value = area * price_per_meter;
    let building_value = 0;
   if (building_area > 0 && building_age > 0) {
  building_value = building_area * 185 / 50 * (50 - building_age);
}


    let total_estimate = land_value + building_value;

    document.getElementById("land_value").innerText = land_value.toFixed(2);
    document.getElementById("building_value").innerText = building_value.toFixed(2);
    document.getElementById("total_estimate").innerText = total_estimate.toFixed(2);
  }

  function fetchPrice() {
    let stateEl  = document.querySelector("input[name='state']");
    let regionEl = document.querySelector("input[name='region']");
    let bankEl   = document.querySelector("select[name='bank_id']");
    if (!stateEl || !regionEl || !bankEl) return;

    let state   = stateEl.value;
    let region  = regionEl.value;
    let bank_id = bankEl.value;

    if (state && region && bank_id) {
      $.post("/get_price", { state, region, bank_id }, function(data) {
        if (data.price_per_meter !== undefined) {
          // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù†ØµØ± price_per_meter ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨ÙƒØŒ Ù†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù† Ù„Ø²Ù…
          if (document.getElementById("price_per_meter")) {
            document.getElementById("price_per_meter").value = data.price_per_meter;
          }
          calculateEstimate();
        }
      });
    }
  }

  // âœ… Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  function toggleTypeFields() {
    const type = document.getElementById("transaction_type")?.value || "";
    const real = document.getElementById("real_estate_fields");
    const veh  = document.getElementById("vehicle_fields");
    const box  = document.getElementById("estimate_box");

    if (real) real.style.display = (type === "real_estate") ? "block" : "none";
    if (veh)  veh.style.display  = (type === "vehicle")     ? "block" : "none";
    if (box)  box.style.display  = (type === "real_estate") ? "block" : "none";
  }

  // ØªØºÙŠÙ‘Ø± Ø§Ù„Ù†ÙˆØ¹
  document.getElementById("transaction_type").addEventListener("change", function() {
    toggleTypeFields();              // âœ… Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±ÙŠ
    // Ù…Ø§ÙÙŠ Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ù…Ø±ÙƒØ¨Ø© Ù‡Ù†Ø§Ø› Ø§Ù„Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·
  });

  // Ù…Ø³ØªÙ…Ø¹Ùˆ Ø§Ù„Ø³Ø¹Ø± (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙ‚Ø·)
  const stateInput  = document.querySelector("input[name='state']");
  const regionInput = document.querySelector("input[name='region']");
  const bankSelect  = document.querySelector("select[name='bank_id']");
  if (stateInput)  stateInput.addEventListener("input", fetchPrice);
  if (regionInput) regionInput.addEventListener("input", fetchPrice);
  if (bankSelect)  bankSelect.addEventListener("change", fetchPrice);

  // Ø£ÙŠ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)
  document.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", calculateEstimate);
  });

  // âœ… Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  toggleTypeFields();
  calculateEstimate();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  if ("serviceWorker" in navigator && "PushManager" in window) {
    navigator.serviceWorker.register("/static/service-worker.js")
      .then(function(reg) { console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„:", reg); })
      .catch(function(err) { console.error("âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err); });
  }
  </script>

  <script>
  // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ø¥Ù„Ù‰ Uint8Array
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function subscribeUser() {
    try {
      const registration = await navigator.serviceWorker.ready;
      const vapidPublicKey = "BFNeZpjEro8pwFxR1H20twlTd2pL5MZtWrDATu4ME2RcbzhN-PBHcpk_jYrRlDUrn4SUxHJ5TOEF796OXs-NN";
      const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
      const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
      await fetch("/save-subscription", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(subscription) });
      alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", err);
      alert("âŒ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }
  }
  </script>

  <!-- Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <button onclick="subscribeUser()" class="btn btn-warning">
    ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  </button>

</body>
</html>
