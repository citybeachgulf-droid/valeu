{% extends 'base.html' %}
{% set title = 'ğŸ‘· Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³' %}

{% block head_extra %}
  <style>
    .table th { background-color: #0d6efd; color: white; text-align: center; }
    .table td { vertical-align: middle; text-align: center; }
    .btn { border-radius: 12px; }
    form.d-flex { justify-content: center; }
    input[type="file"] { max-width: 160px; }
  </style>
{% endblock %}

{% block navbar %}
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 animate__animated animate__fadeInDown">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ğŸ› ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('engineer_dashboard') }}">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li class="nav-item"><a class="nav-link text-warning" href="/reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
        </ul>
      </div>
    </div>
  </nav>
{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-up">
      <h2 class="text-primary">ğŸ‘· Ø£Ù‡Ù„Ø§Ù‹ {{ engineer.name }}</h2>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3" data-aos="fade-up">
      <h3>ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</h3>
      <a href="{{ url_for('add_transaction_engineer') }}" class="btn btn-success">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</a>
    </div>

    <div class="card shadow-lg" data-aos="zoom-in">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h5>
      </div>
      <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ«Ù…ÙŠÙ†</th>
                <th>Ø§Ù„Ø¨Ù†Ùƒ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>ğŸ“‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transactions %}
              <tr data-aos="fade-up" data-aos-delay="{{ loop.index0 * 40 }}">
                <td>{{ t.id }}</td>
                <td>{{ t.client }}</td>
                <td>{{ "%.2f"|format(t.valuation_amount or 0) }}</td>
                <td>{{ t.bank.name if t.bank else "â€”" }}</td>
                <td>{{ t.status }}</td>
                <td>
                  <a href="{{ url_for('engineer_transaction_details', tid=t.id) }}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                </td>
                <td>
                  {% if not t.assigned_to and (t.status == "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³" or t.status == "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³") %}
                    <a href="{{ url_for('engineer_take', tid=t.id) }}" class="btn btn-sm btn-primary">Ø§Ø³ØªÙ„Ø§Ù…</a>
                  {% elif t.assigned_to == engineer.id and t.status == "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©" %}
                    <form method="POST" action="{{ url_for('engineer_upload_report', tid=t.id) }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                      <input type="file" name="report_file" class="form-control form-control-sm" accept=".pdf,.doc,.docx" required>
                      <button type="submit" class="btn btn-sm btn-success">ğŸ“¤ Ø±ÙØ¹</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
        {% endif %}
      </div>
    </div>

    <div class="mt-3" data-aos="fade-up">
      <button onclick="subscribeUser()" class="btn btn-warning">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
if ("serviceWorker" in navigator && "PushManager" in window) {
  navigator.serviceWorker.register("/static/service-worker.js")
    .then(function(reg) { console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„:", reg); })
    .catch(function(err) { console.error("âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err); });
}

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function subscribeUser() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const vapidPublicKey = "{{ vapid_public_key }}";
    const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
    const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
    await fetch("/save-subscription", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(subscription) });
    alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", err);
    alert("âŒ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
  }
}
</script>
{% endblock %}
