{% extends 'base.html' %}
{% set title = '👷 لوحة المهندس' %}

{% block head_extra %}
  <style>
    .table th { background-color: #0d6efd; color: white; text-align: center; }
    .table td { vertical-align: middle; text-align: center; }
    .btn { border-radius: 12px; }
    form.d-flex { justify-content: center; }
    input[type="file"] { max-width: 160px; }
  </style>
{% endblock %}

{% block navbar %}
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 animate__animated animate__fadeInDown">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">🛠️ نظام التثمين</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('engineer_dashboard') }}">🏠 الصفحة الرئيسية</a></li>
          <li class="nav-item"><a class="nav-link text-warning" href="/reports">📑 التقارير</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">🚪 تسجيل الخروج</a></li>
        </ul>
      </div>
    </div>
  </nav>
{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-up">
      <h2 class="text-primary">👷 أهلاً {{ engineer.name }}</h2>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">تسجيل الخروج</a>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3" data-aos="fade-up">
      <h3>📋 معاملات المهندس</h3>
      <a href="{{ url_for('add_transaction_engineer') }}" class="btn btn-success">➕ إضافة معاملة</a>
    </div>

    <div class="card shadow-lg" data-aos="zoom-in">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">📋 قائمة المعاملات</h5>
      </div>
      <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>اسم العميل</th>
                <th>قيمة التثمين</th>
                <th>البنك</th>
                <th>الحالة</th>
                <th>📂 التفاصيل</th>
                <th>الإجراء</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transactions %}
              <tr data-aos="fade-up" data-aos-delay="{{ loop.index0 * 40 }}">
                <td>{{ t.id }}</td>
                <td>{{ t.client }}</td>
                <td>{{ "%.2f"|format(t.valuation_amount or 0) }}</td>
                <td>{{ t.bank.name if t.bank else "—" }}</td>
                <td>{{ t.status }}</td>
                <td>
                  <a href="{{ url_for('engineer_transaction_details', tid=t.id) }}" class="btn btn-info btn-sm">👁️ عرض التفاصيل</a>
                </td>
                <td>
                  {% if not t.assigned_to and (t.status == "بانتظار المهندس" or t.status == "بانتظار تقرير المهندس") %}
                    <a href="{{ url_for('engineer_take', tid=t.id) }}" class="btn btn-sm btn-primary">استلام</a>
                  {% elif t.assigned_to == engineer.id and t.status == "قيد المعاينة" %}
                    <form method="POST" action="{{ url_for('engineer_upload_report', tid=t.id) }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                      <input type="file" name="report_file" class="form-control form-control-sm" accept=".pdf,.doc,.docx" required>
                      <button type="submit" class="btn btn-sm btn-success">📤 رفع</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-center text-muted">لا توجد معاملات متاحة حالياً.</p>
        {% endif %}
      </div>
    </div>

    <div class="mt-3" data-aos="fade-up">
      <button onclick="subscribeUser()" class="btn btn-warning">🔔 تفعيل الإشعارات</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
if ("serviceWorker" in navigator && "PushManager" in window) {
  navigator.serviceWorker.register("/static/service-worker.js")
    .then(function(reg) { console.log("✅ Service Worker مسجل:", reg); })
    .catch(function(err) { console.error("❌ فشل التسجيل:", err); });
}

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function subscribeUser() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const vapidPublicKey = "{{ vapid_public_key }}";
    const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
    const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
    await fetch("/save-subscription", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(subscription) });
    alert("✅ تم تفعيل الإشعارات");
  } catch (err) {
    console.error("❌ خطأ في الاشتراك:", err);
    alert("❌ فشل تفعيل الإشعارات");
  }
}
</script>
{% endblock %}
