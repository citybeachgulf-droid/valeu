<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>๐ฐ ููุญุฉ ุงููุงููุฉ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
 <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">๐๏ธ ูุธุงู ุงูุชุซููู</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <!-- ุฒุฑ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('finance_dashboard') }}">๐ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('finance_paid') }}">โ ุงููุฏููุนุฉ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('finance_templates') }}">๐ ุงูููุงูุจ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('customers_page') }}">๐ฅ ุงูุนููุงุก</a>
        </li>
        <!-- ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ -->
        <li class="nav-item">
          <a class="nav-link text-danger" href="{{ url_for('logout') }}">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</a>
        </li>
          <li class="nav-item">
            <a class="nav-link text-warning" href="/reports">๐ ุงูุชูุงุฑูุฑ</a>
          </li>
      </ul>
    </div>
  </div>
</nav>
<body class="bg-light">

<div class="container py-4">

  <h2 class="mb-4">๐ฐ ููุญุฉ ุงูุชุญูู ุงููุงููุฉ</h2>

  <!-- ุฅูุดุงุก ุนุฑุถ ุณุนุฑ ููุงุชูุฑุฉ ุจูู / ุนููู -->
  <div class="row mb-4">
    <!-- ุชู ุฅุฒุงูุฉ ูุณู "ุฅูุดุงุก ุนุฑุถ ุณุนุฑ ููุจูู" -->

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐ ุฅูุดุงุก ูุงุชูุฑุฉ ุจูู</h5>
          <form method="POST" action="{{ url_for('finance_create_bank_invoice') }}" class="row g-2">
            <div class="col-md-6">
              <label class="form-label">ุงูุจูู</label>
              <select name="bank_id" class="form-select" required>
                <option value="">ุงุฎุชุฑ ุงูุจูู</option>
                {% for b in banks %}
                  <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุงููุจูุบ</label>
              <input type="number" step="0.01" name="amount" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุฑูู ูุนุงููุฉ (ุงุฎุชูุงุฑู)</label>
              <input type="number" name="transaction_id" class="form-control" placeholder="ุฅู ูุฌุฏ">
            </div>
            <div class="col-md-6">
              <label class="form-label">ููุงุญุธุฉ</label>
              <input type="text" name="note" class="form-control" placeholder="ููุงุญุธุฉ">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-success">ุฅุตุฏุงุฑ ูุงุชูุฑุฉ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐งพ ุฅูุดุงุก ุนุฑุถ ุณุนุฑ ููุนููู</h5>
          <form method="POST" action="{{ url_for('finance_create_customer_quote') }}" class="row g-2">
            <div class="col-md-6">
              <label class="form-label">ุงุณู ุงูุนููู</label>
              <input type="text" name="customer_name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุงููุจูุบ</label>
              <input type="number" step="0.01" name="amount" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุตุงูุญ ุญุชู (ุงุฎุชูุงุฑู)</label>
              <input type="date" name="valid_until" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">ุฑูู ูุนุงููุฉ (ุงุฎุชูุงุฑู)</label>
              <input type="number" name="transaction_id" class="form-control" placeholder="ุฅู ูุฌุฏ">
            </div>
            <div class="col-12">
              <label class="form-label">ููุงุญุธุฉ</label>
              <input type="text" name="note" class="form-control" placeholder="ููุงุญุธุฉ">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-primary">ุฅูุดุงุก</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐งฎ ุฅูุดุงุก ูุงุชูุฑุฉ ููุนููู</h5>
          <form method="POST" action="{{ url_for('finance_create_customer_invoice') }}" class="row g-2">
            <div class="col-md-6">
              <label class="form-label">ุงุณู ุงูุนููู</label>
              <input type="text" name="customer_name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุงููุจูุบ</label>
              <input type="number" step="0.01" name="amount" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">ุฑูู ูุนุงููุฉ (ุงุฎุชูุงุฑู)</label>
              <input type="number" name="transaction_id" class="form-control" placeholder="ุฅู ูุฌุฏ">
            </div>
            <div class="col-md-6">
              <label class="form-label">ููุงุญุธุฉ</label>
              <input type="text" name="note" class="form-control" placeholder="ููุงุญุธุฉ">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-success">ุฅุตุฏุงุฑ ูุงุชูุฑุฉ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ุงูุจุทุงูุงุช -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>๐ฅ ุฅุฌูุงูู ุงูุฏุฎู</h5>
          <p class="fs-4 text-success">{{ total_income }} ุฑูุงู</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>๐ค ุฅุฌูุงูู ุงููุตุงุฑูู</h5>
          <p class="fs-4 text-danger">{{ total_expenses }} ุฑูุงู</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>๐น ุตุงูู ุงูุฑุจุญ</h5>
          <p class="fs-4 text-primary">{{ net_profit }} ุฑูุงู</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ุฌุฏูู ุงููุนุงููุงุช ุงูุบูุฑ ูุฏููุนุฉ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">โ ุงููุนุงููุงุช ุบูุฑ ุงููุฏููุนุฉ</h5>
      <table class="table table-bordered">
  <thead>
    <tr>
      <th>#</th>
      <th>ุงูุนููู</th>
      <th>ุงูููุธู</th>
      <th>ุงูุฑุณูู</th>
      <th>ุงููุฏููุน</th>
      <th>ุงูุญุงูุฉ</th>
      <th>ุฅุถุงูุฉ ุฏูุนุฉ</th>
      <th>ุชูุฒูู ูุณุชูุฏ</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.id }}</td>
      <td>{{ t.client }}</td>
      <td>{{ t.employee }}</td>
      <td>{{ t.fee }} ุฑูุงู</td>
      <td>{{ t.paid }} ุฑูุงู</td>
      <td>{{ t.payment_status }}</td>
      <td>
        <form action="{{ url_for('add_payment', tid=t.id) }}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
          <input type="number" step="0.01" name="amount" placeholder="ุงููุจูุบ" class="form-control form-control-sm" required>
          <select name="method" class="form-select form-select-sm" required>
            <option value="ูุงุด">ูุงุด</option>
            <option value="ุชุญููู">ุชุญููู</option>
          </select>
          <input type="file" name="receipt_file" class="form-control form-control-sm">
          <button type="submit" class="btn btn-success btn-sm">๐ต</button>
        </form>
      </td>
      <td class="text-nowrap">
        <a href="{{ url_for('download_quote_doc', transaction_id=t.id) }}" class="btn btn-outline-primary btn-sm">ุนุฑุถ ุณุนุฑ</a>
        <a href="{{ url_for('download_invoice_doc', transaction_id=t.id) }}" class="btn btn-outline-secondary btn-sm">ุชูุฒูู</a>
        <a href="{{ url_for('print_invoice_html', transaction_id=t.id) }}?auto=1" class="btn btn-sm btn-success">ุทุจุงุนุฉ</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

    </div>
  </div>

  <!-- ุชู ููู ุฌุฏูู ุงููุนุงููุงุช ุงููุฏููุนุฉ ุฅูู ุตูุญุฉ ูููุตูุฉ -->

  <!-- ุงูุนุฑูุถ ุงูุฃุฎูุฑุฉ ูุงูููุงุชูุฑ ุงูุฃุฎูุฑุฉ (ุจููู) -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐ ุขุฎุฑ ููุงุชูุฑ ุงูุจููู</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>ุงูุจูู</th>
                  <th>ุงููุจูุบ</th>
                  <th>ุฅุตุฏุงุฑ</th>
                  <th>ุชุณููู</th>
                  <th>ุงุณุชูุงู</th>
                  <th>ุงูุญุงูุฉ</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody>
                {% for inv in recent_bank_invoices %}
                <tr>
                  <td>{{ inv.id }}</td>
                  <td>{{ inv.bank_id }}</td>
                  <td>{{ inv.amount }}</td>
                  <td>{{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '-' }}</td>
                  <td>{{ inv.delivered_at.strftime('%Y-%m-%d') if inv.delivered_at else '-' }}</td>
                  <td>{{ inv.received_at.strftime('%Y-%m-%d') if inv.received_at else '-' }}</td>
                  <td>
                    {% if inv.received_at %}
                      ุชู ุงุณุชูุงู ุงููุจูุบ
                    {% elif inv.delivered_at %}
                      ุชู ุงูุชุณููู
                    {% elif inv.issued_at %}
                      ุชู ุงูุฅุตุฏุงุฑ
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="text-nowrap">
                    <div class="d-flex gap-2 flex-wrap">
                      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_bank_invoice_doc', invoice_id=inv.id) }}">ุชูุฒูู</a>
                      {% if not inv.delivered_at %}
                      <form method="post" action="{{ url_for('finance_update_bank_invoice_status', invoice_id=inv.id) }}">
                        <input type="hidden" name="action" value="deliver">
                        <button class="btn btn-sm btn-warning">ุชุณููู</button>
                      </form>
                      {% endif %}
                      {% if inv.delivered_at and not inv.received_at %}
                      <form method="post" action="{{ url_for('finance_update_bank_invoice_status', invoice_id=inv.id) }}">
                        <input type="hidden" name="action" value="receive">
                        <button class="btn btn-sm btn-success">ุงุณุชูุงู</button>
                      </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center">ูุง ุชูุฌุฏ ููุงุชูุฑ ุจุนุฏ</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ุงูุนุฑูุถ ุงูุฃุฎูุฑุฉ ูุงูููุงุชูุฑ ุงูุฃุฎูุฑุฉ (ุนููุงุก) -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐งพ ุขุฎุฑ ุนุฑูุถ ุฃุณุนุงุฑ ุงูุนููุงุก</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>ุงูุนููู</th>
                  <th>ุงููุจูุบ</th>
                  <th>ุตุงูุญ ุญุชู</th>
                  <th>ููุงุญุธุฉ</th>
                </tr>
              </thead>
              <tbody>
                {% for q in recent_customer_quotes %}
                <tr>
                  <td>{{ q.id }}</td>
                  <td>{{ q.customer_name }}</td>
                  <td>{{ q.amount }}</td>
                  <td>{{ q.valid_until.strftime('%Y-%m-%d') if q.valid_until else '-' }}</td>
                  <td class="d-flex gap-2">
                    <span>{{ q.note or '-' }}</span>
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_customer_quote_doc', quote_id=q.id) }}">ุชูุฒูู</a>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center">ูุง ุชูุฌุฏ ุนุฑูุถ ุนููุงุก ุจุนุฏ</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">๐งฎ ุขุฎุฑ ููุงุชูุฑ ุงูุนููุงุก</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>ุงูุนููู</th>
                  <th>ุงููุจูุบ</th>
                  <th>ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ</th>
                  <th>ููุงุญุธุฉ</th>
                </tr>
              </thead>
              <tbody>
                {% for inv in recent_customer_invoices %}
                <tr>
                  <td>{{ inv.id }}</td>
                  <td>{{ inv.customer_name }}</td>
                  <td>{{ inv.amount }}</td>
                  <td>{{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '-' }}</td>
                  <td class="d-flex gap-2">
                    <span>{{ inv.note or '-' }}</span>
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_customer_invoice_doc', invoice_id=inv.id) }}">ุชูุฒูู</a>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center">ูุง ุชูุฌุฏ ููุงุชูุฑ ุนููุงุก ุจุนุฏ</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">โ ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ</h5>
      <form method="POST" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">ุงุณู ุงููุตุฑูู</label>
            <input type="text" name="expense_name" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">ุงููุจูุบ</label>
            <input type="number" step="0.01" name="amount" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">๐ ุฅูุตุงู ุงููุตุฑูู</label>
            <input type="file" name="file" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-danger w-100">ุญูุธ</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ุฌุฏูู ุงููุตุงุฑูู -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">๐ ุณุฌู ุงููุตุงุฑูู</h5>
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>ุงุณู ุงููุตุฑูู</th>
            <th>ุงููุจูุบ</th>
            <th>ุงูุชุงุฑูุฎ</th>
            <th>ุงูุฅูุตุงู</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          <tr>
            <td>{{ e.id }}</td>
            <td>{{ e.name }}</td>
            <td>{{ e.amount }} ุฑูุงู</td>
            <td>{{ e.date }}</td>
            <td>
              {% if e.file %}
                <a href="{{ url_for('uploaded_file', filename=e.file) }}" target="_blank">๐ ุนุฑุถ</a>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center">โ ูุง ุชูุฌุฏ ูุตุงุฑูู ูุณุฌูุฉ</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
if ("serviceWorker" in navigator && "PushManager" in window) {
 navigator.serviceWorker.register("/static/service-worker.js")
    .then(function(reg) {
      console.log("โ Service Worker ูุณุฌู:", reg);
    })
    .catch(function(err) {
      console.error("โ ูุดู ุงูุชุณุฌูู:", err);
    });
}
</script>





<script>
// ุฏุงูุฉ ูุชุญููู ุงูููุชุงุญ ุงูุนุงู ุฅูู Uint8Array
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, "+")
    .replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

async function subscribeUser() {
  try {
    // ูุชุฃูุฏ ุฃู ุงูู Service Worker ุฌุงูุฒ
    const registration = await navigator.serviceWorker.ready;

    // ุงูููุชุงุญ ุงูุนุงู ูู Flask
    const vapidPublicKey = "BFNeZpjEro8pwFxR1H20twlTd2pL5MZtWrDATu4ME2RcbzhN-PBHcpk_jYrRlDUrn4SUxHJ5TOEF796OXs-NN";
    const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);

    // ูุทูุจ ุงูุงุดุชุฑุงู
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey
    });

    // ูุฑุณู ุงูุงุดุชุฑุงู ููุณูุฑูุฑ
    await fetch("/save-subscription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(subscription)
    });

    console.log("โ ุชู ุงูุงุดุชุฑุงู ุจูุฌุงุญ:", subscription);
    alert("โ ุชู ุชูุนูู ุงูุฅุดุนุงุฑุงุช");
  } catch (err) {
    console.error("โ ุฎุทุฃ ูู ุงูุงุดุชุฑุงู:", err);
    alert("โ ูุดู ุชูุนูู ุงูุฅุดุนุงุฑุงุช");
  }
}
</script>

<!-- ุฒุฑ ุชูุนูู ุงูุฅุดุนุงุฑุงุช -->
<button onclick="subscribeUser()" class="btn btn-warning">
  ๐ ุชูุนูู ุงูุฅุดุนุงุฑุงุช
</button>


</body>
</html>
