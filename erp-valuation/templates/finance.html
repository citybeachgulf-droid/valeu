{% extends 'base.html' %}
{% set title = 'ğŸ’° Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©' %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 animate__animated animate__fadeInDown">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">ğŸ› ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('finance_dashboard') }}">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('finance_paid') }}">âœ… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('customers_page') }}">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
        <li class="nav-item"><a class="nav-link text-warning" href="/reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
        <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
      </ul>
    </div>
  </div>

</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4" data-aos="fade-up">ğŸ’° Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>

  <!-- Tabs header -->
  <ul class="nav nav-tabs mb-3" id="financeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bank-invoices-tab" data-bs-toggle="tab" data-bs-target="#bank-invoices" type="button" role="tab" aria-controls="bank-invoices" aria-selected="true">ğŸ¦ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="customer-quotes-tab" data-bs-toggle="tab" data-bs-target="#customer-quotes" type="button" role="tab" aria-controls="customer-quotes" aria-selected="false">ğŸ§¾ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="customer-invoices-tab" data-bs-toggle="tab" data-bs-target="#customer-invoices" type="button" role="tab" aria-controls="customer-invoices" aria-selected="false">ğŸ§® ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    </li>
  </ul>

  <div class="tab-content mb-4" id="financeTabsContent">
    <!-- Bank Invoices Tab -->
    <div class="tab-pane fade show active" id="bank-invoices" role="tabpanel" aria-labelledby="bank-invoices-tab" tabindex="0">
      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-6" data-aos="zoom-in">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ùƒ</h5>
              <form method="POST" action="{{ url_for('finance_create_bank_invoice') }}" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Ø§Ù„Ø¨Ù†Ùƒ</label>
                  <select name="bank_id" class="form-select" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ</option>
                    {% for b in banks %}
                      <option value="{{ b.id }}">{{ b.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                  <input type="number" step="0.01" name="amount" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="number" name="transaction_id" class="form-control" placeholder="Ø¥Ù† ÙˆØ¬Ø¯">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                  <input type="text" name="note" class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button class="btn btn-success">Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø©</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ“„ Ø¢Ø®Ø± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ</h5>
              <div class="table-responsive">
                <table class="table table-bordered table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>Ø§Ù„Ø¨Ù†Ùƒ</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                      <th>Ø¥ØµØ¯Ø§Ø±</th>
                      <th>ØªØ³Ù„ÙŠÙ…</th>
                      <th>Ø§Ø³ØªÙ„Ø§Ù…</th>
                      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for inv in recent_bank_invoices %}
                    <tr>
                      <td>{{ inv.id }}</td>
                      <td>{{ inv.bank_id }}</td>
                      <td>{{ inv.amount }}</td>
                      <td>{{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '-' }}</td>
                      <td>{{ inv.delivered_at.strftime('%Y-%m-%d') if inv.delivered_at else '-' }}</td>
                      <td>{{ inv.received_at.strftime('%Y-%m-%d') if inv.received_at else '-' }}</td>
                      <td>
                        {% if inv.received_at %}ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº{% elif inv.delivered_at %}ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…{% elif inv.issued_at %}ØªÙ… Ø§Ù„Ø¥ØµØ¯Ø§Ø±{% else %}-{% endif %}
                      </td>
                      <td class="text-nowrap">
                        <div class="d-flex gap-2 flex-wrap">
                          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_bank_invoice_doc', invoice_id=inv.id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                          {% if not inv.delivered_at %}
                          <form method="post" action="{{ url_for('finance_update_bank_invoice_status', invoice_id=inv.id) }}">
                            <input type="hidden" name="action" value="deliver">
                            <button class="btn btn-sm btn-warning">ØªØ³Ù„ÙŠÙ…</button>
                          </form>
                          {% endif %}
                          {% if inv.delivered_at and not inv.received_at %}
                          <form method="post" action="{{ url_for('finance_update_bank_invoice_status', invoice_id=inv.id) }}">
                            <input type="hidden" name="action" value="receive">
                            <button class="btn btn-sm btn-success">Ø§Ø³ØªÙ„Ø§Ù…</button>
                          </form>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Quotes Tab -->
    <div class="tab-pane fade" id="customer-quotes" role="tabpanel" aria-labelledby="customer-quotes-tab" tabindex="0">
      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-6" data-aos="zoom-in">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„</h5>
              <form method="POST" action="{{ url_for('finance_create_customer_quote') }}" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" name="customer_name" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                  <input type="number" step="0.01" name="amount" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">ØµØ§Ù„Ø­ Ø­ØªÙ‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="date" name="valid_until" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="number" name="transaction_id" class="form-control" placeholder="Ø¥Ù† ÙˆØ¬Ø¯">
                </div>
                <div class="col-12">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                  <input type="text" name="note" class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ§¾ Ø¢Ø®Ø± Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
              <div class="table-responsive">
                <table class="table table-bordered table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                      <th>ØµØ§Ù„Ø­ Ø­ØªÙ‰</th>
                      <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for q in recent_customer_quotes %}
                    <tr>
                      <td>{{ q.id }}</td>
                      <td>{{ q.customer_name }}</td>
                      <td>{{ q.amount }}</td>
                      <td>{{ q.valid_until.strftime('%Y-%m-%d') if q.valid_until else '-' }}</td>
                      <td class="d-flex gap-2">
                        <span>{{ q.note or '-' }}</span>
                        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_customer_quote_doc', quote_id=q.id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                      </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Invoices Tab -->
    <div class="tab-pane fade" id="customer-invoices" role="tabpanel" aria-labelledby="customer-invoices-tab" tabindex="0">
      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-6" data-aos="zoom-in" data-aos-delay="80">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ§® Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</h5>
              <form method="POST" action="{{ url_for('finance_create_customer_invoice') }}" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" name="customer_name" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                  <input type="number" step="0.01" name="amount" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input type="number" name="transaction_id" class="form-control" placeholder="Ø¥Ù† ÙˆØ¬Ø¯">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                  <input type="text" name="note" class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button class="btn btn-success">Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø©</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4" data-aos="fade-up">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">ğŸ§® Ø¢Ø®Ø± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
              <div class="table-responsive">
                <table class="table table-bordered table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                      <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                      <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for inv in recent_customer_invoices %}
                    <tr>
                      <td>{{ inv.id }}</td>
                      <td>{{ inv.customer_name }}</td>
                      <td>{{ inv.amount }}</td>
                      <td>{{ inv.issued_at.strftime('%Y-%m-%d') if inv.issued_at else '-' }}</td>
                      <td class="d-flex gap-2">
                        <span>{{ inv.note or '-' }}</span>
                        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_customer_invoice_doc', invoice_id=inv.id) }}">ØªÙ†Ø²ÙŠÙ„</a>
                      </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row mb-4" data-aos="fade-up">
    <div class="col-md-4" data-aos="zoom-in">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>ğŸ“¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</h5>
          <p class="fs-4 text-success">{{ total_income }} Ø±ÙŠØ§Ù„</p>
        </div>
      </div>
    </div>
    <div class="col-md-4" data-aos="zoom-in" data-aos-delay="60">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>ğŸ“¤ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h5>
          <p class="fs-4 text-danger">{{ total_expenses }} Ø±ÙŠØ§Ù„</p>
        </div>
      </div>
    </div>
    <div class="col-md-4" data-aos="zoom-in" data-aos-delay="120">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h5>ğŸ’¹ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h5>
          <p class="fs-4 text-primary">{{ net_profit }} Ø±ÙŠØ§Ù„</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Unpaid transactions table remains as is -->
  <div class="card shadow-sm mb-4" data-aos="fade-up">
    <div class="card-body">
      <h5 class="mb-3">âŒ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</h5>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
            <th>Ø§Ù„Ø±Ø³ÙˆÙ…</th>
            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</th>
            <th>ØªÙ†Ø²ÙŠÙ„ Ù…Ø³ØªÙ†Ø¯</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
          <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.client }}</td>
            <td>{{ t.employee }}</td>
            <td>{{ t.fee }} Ø±ÙŠØ§Ù„</td>
            <td>{{ t.paid }} Ø±ÙŠØ§Ù„</td>
            <td>{{ t.payment_status }}</td>
            <td>
              <form action="{{ url_for('add_payment', tid=t.id) }}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                <input type="number" step="0.01" name="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="form-control form-control-sm" required>
                <select name="method" class="form-select form-select-sm" required>
                  <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                  <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
                </select>
                <input type="file" name="receipt_file" class="form-control form-control-sm">
                <button type="submit" class="btn btn-success btn-sm">ğŸ’µ</button>
              </form>
            </td>
            <td>
              <form method="get" class="row g-2 align-items-end">
                <div class="col-12">
                  <input type="text" name="details" class="form-control form-control-sm" placeholder="ÙˆØµÙ/ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                </div>
                <div class="col-6">
                  <label class="form-label mb-1 small">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %</label>
                  <input type="number" name="vat" class="form-control form-control-sm" value="{{ vat_default_percent }}" min="0" max="100" step="0.01">
                </div>
                <div class="col-6">
                  <label class="form-label mb-1 small">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                  <select name="apply_vat" class="form-select form-select-sm">
                    <option value="1" selected>Ù†Ø¹Ù…</option>
                    <option value="0">Ù„Ø§</option>
                  </select>
                </div>
                <div class="col-12 d-flex gap-2 flex-wrap">
                  <button type="submit" formaction="{{ url_for('download_quote_doc', transaction_id=t.id) }}" class="btn btn-outline-primary btn-sm">Ø¹Ø±Ø¶ Ø³Ø¹Ø±</button>
                  <button type="submit" formaction="{{ url_for('download_invoice_doc', transaction_id=t.id) }}" class="btn btn-outline-secondary btn-sm">ÙØ§ØªÙˆØ±Ø©</button>
                  <button type="submit" formaction="{{ url_for('print_invoice_html', transaction_id=t.id) }}?auto=1" class="btn btn-sm btn-success">Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add expense -->
  <div class="card shadow-sm" data-aos="fade-up">
    <div class="card-body">
      <h5 class="mb-3">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h5>
      <form method="POST" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
            <input type="text" name="expense_name" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input type="number" step="0.01" name="amount" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">ğŸ“ Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
            <input type="file" name="file" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-danger w-100">Ø­ÙØ¸</button>
          </div>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// ØªØªØ¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨
var __isUserEditing = false;
var __updateBannerEl = null;
function __setupEditingGuards(){
  try {
    var formEl = document.querySelector('form');
    var inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(function(el){
      el.addEventListener('focus', function(){ __isUserEditing = true; });
      el.addEventListener('input', function(){ __isUserEditing = true; });
      el.addEventListener('blur', function(){ setTimeout(function(){ __isUserEditing = false; }, 1000); });
    });
    if (formEl) formEl.addEventListener('submit', function(){ __isUserEditing = false; });
  } catch (_) {}
}
function __ensureUpdateBanner(){
  if (__updateBannerEl) return __updateBannerEl;
  var banner = document.createElement('div');
  banner.style.position = 'fixed';
  banner.style.bottom = '16px';
  banner.style.left = '50%';
  banner.style.transform = 'translateX(-50%)';
  banner.style.background = '#0d6efd';
  banner.style.color = '#fff';
  banner.style.padding = '10px 14px';
  banner.style.borderRadius = '8px';
  banner.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  banner.style.display = 'none';
  banner.style.zIndex = '2147483647';
  banner.innerHTML = 'Ø­Ø¯Ø« ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª. <button id="__doReloadBtn" style="margin-inline-start:8px" class="btn btn-light btn-sm">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>';
  document.body.appendChild(banner);
  var btn = banner.querySelector('#__doReloadBtn');
  if (btn) btn.addEventListener('click', function(){ location.reload(); });
  __updateBannerEl = banner;
  return banner;
}
document.addEventListener('DOMContentLoaded', __setupEditingGuards);
</script>
<script>
// ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ Ø¨Ø³ÙŠØ·: ÙØ­Øµ Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø±Ù‡Ø§
(function autoReloadOnChanges(){
  var currentVersion = null;
  var lastPingFail = 0;
  async function checkVersion(){
    try {
      const res = await fetch('/api/transactions/version', { cache: 'no-store' });
      if (!res.ok) throw new Error('bad status');
      const data = await res.json();
      if (currentVersion === null) {
        currentVersion = data.version;
      } else if (data.version !== currentVersion) {
        if (!__isUserEditing) {
          location.reload();
        } else {
          var b = __ensureUpdateBanner();
          b.style.display = 'block';
        }
      }
    } catch (e) {
      lastPingFail++;
      if (lastPingFail > 5) lastPingFail = 0;
    }
  }
  setInterval(checkVersion, 3000);
  setTimeout(checkVersion, 1000);
})();
</script>
<script>
if ("serviceWorker" in navigator && "PushManager" in window) {
  navigator.serviceWorker.register("/service-worker.js")
    .then(function(reg) {
      console.log("âœ… Service Worker Ù…Ø³Ø¬Ù„:", reg);
      if (Notification && Notification.permission !== "granted") {
        Notification.requestPermission().then(function() {
          subscribeUser().catch(console.error);
        });
      } else {
        subscribeUser().catch(console.error);
      }
    })
    .catch(function(err) { console.error("âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err); });
}

// ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ PUSH
(function setupBeepListener(){
  if (!navigator.serviceWorker) return;
  navigator.serviceWorker.addEventListener("message", function(event){
    if (!event || !event.data || event.data.type !== "PUSH_NOTIFICATION") return;
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      o.connect(g);
      g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
      o.start();
      o.stop(ctx.currentTime + 0.4);
    } catch (_) {}
  });
})();

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

async function subscribeUser() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const vapidPublicKey = "{{ vapid_public_key }}";
    const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
    const existing = await registration.pushManager.getSubscription();
    if (!existing) {
      const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
      await fetch("/save-subscription", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(subscription) });
    }
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:", err);
  }
}
</script>

{% endblock %}


