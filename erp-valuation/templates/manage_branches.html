{% extends 'base.html' %}
{% from 'partials/nav.html' import manager_nav %}
{% set title = 'إدارة الفروع' %}

{% block navbar %}
  {{ manager_nav(active='branches') }}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>إدارة الفروع والأقسام</h1>
  <div class="app-page-title__meta">
    <span>إنشاء الفروع، إضافة الأقسام، والوصول إلى واجهات العمل.</span>
    <span class="pill">عدد الفروع: {{ branches|length }}</span>
  </div>
</div>

<div class="app-grid app-grid--two" data-aos="fade-up" data-aos-delay="80">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">إنشاء فرع جديد</h3>
        <p class="app-card__subtitle mb-0">أضف فرعاً جديداً وحدد القسم الأساسي له.</p>
      </div>
    </div>
    <form method="POST" class="row g-3 text-start">
      <input type="hidden" name="_action" value="create_branch">
      <div class="col-12 col-md-6">
        <label class="form-label">اسم الفرع</label>
        <input type="text" name="name" class="form-control" placeholder="مثل: فرع الرياض الشمالي" required>
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">القسم الافتراضي</label>
        <select name="department" class="form-select">
          <option value="">دون قسم محدد</option>
          <option value="valuation">التقييم</option>
          <option value="consultations">الاستشارات</option>
          <option value="finance">المالية</option>
        </select>
      </div>
      <div class="col-12 d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">حفظ الفرع</button>
      </div>
    </form>
  </div>

  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">إضافة قسم لفرع</h3>
        <p class="app-card__subtitle mb-0">قم بإنشاء أقسام داخلية لإدارة الأعمال المتخصصة.</p>
      </div>
    </div>
    <form method="POST" class="row g-3 text-start">
      <input type="hidden" name="_action" value="add_section">
      <div class="col-12 col-md-4">
        <label class="form-label">اختر الفرع</label>
        <select name="branch_id" class="form-select" required>
          <option value="" disabled selected>اختيار الفرع</option>
          {% for b in branches %}
            <option value="{{ b.id }}">{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-5">
        <label class="form-label">اسم القسم</label>
        <input type="text" name="section_name" class="form-control" placeholder="مثل: الملاك أو إدارة الأملاك" required>
        <div class="form-text mt-1">سيظهر القسم داخل واجهات الفرع المختارة.</div>
      </div>
      <div class="col-12 col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-primary w-100">إضافة القسم</button>
      </div>
    </form>
  </div>
</div>

<div class="app-section" data-aos="fade-up" data-aos-delay="140">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">قائمة الفروع</h3>
        <p class="app-card__subtitle mb-0">الوصول السريع لواجهات الفروع والأقسام وإدارتها.</p>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>اسم الفرع</th>
            <th>القسم الرئيسي</th>
            <th>الأقسام والإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for b in branches %}
          <tr>
            <td>{{ b.id }}</td>
            <td class="fw-semibold">{{ b.name }}</td>
            <td>
              {% set dept = (b.department or '').lower() %}
              {% if dept == 'consultations' %}
                الاستشارات
              {% elif dept == 'finance' %}
                المالية
              {% elif dept == 'valuation' %}
                التقييم
              {% else %}
                <span class="text-muted">غير محدد</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('open_branch_interface', bid=b.id) }}" class="btn btn-sm btn-primary">فتح الواجهة</a>
                {% if b.ordered_sections %}
                  {% for s in b.ordered_sections %}
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <a href="{{ url_for('open_branch_section', bid=b.id, section=s.name) }}" class="btn btn-sm btn-outline-secondary">
                      قسم: {{ 'الاستشارات' if s.name=='consultations' else ('التقييم' if s.name=='valuation' else ('إدارة الأملاك' if s.name=='property_management' else ('جمعيات الملاك' if s.name=='owners_associations' else s.name))) }}
                    </a>
                    <form method="POST" action="{{ url_for('manage_branches') }}" onsubmit="return confirm('هل أنت متأكد من حذف هذا القسم؟');">
                      <input type="hidden" name="_action" value="delete_section">
                      <input type="hidden" name="section_id" value="{{ s.id }}">
                      <button class="btn btn-sm btn-outline-danger">حذف</button>
                    </form>
                  </div>
                  {% endfor %}
                {% endif %}
                <a href="{{ url_for('open_branch_section', bid=b.id, section='finance') }}" class="btn btn-sm btn-warning text-dark">واجهة المالية</a>
                <a href="{{ url_for('delete_branch', bid=b.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('هل أنت متأكد من حذف الفرع؟');">حذف الفرع</a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted py-4">لا توجد فروع مسجلة حالياً.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
