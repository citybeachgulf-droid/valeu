{% extends 'base.html' %}
{% from 'partials/nav.html' import manager_nav %}
{% set title = 'إدارة حسابات الموظفين' %}

{% block navbar %}
  {{ manager_nav(active='employees') }}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>إدارة حسابات الموظفين</h1>
  <div class="app-page-title__meta">
    <span>إنشاء حسابات جديدة وربطها بالفروع والأشخاص المعتمدين.</span>
    <span class="pill">إجمالي المستخدمين: {{ users|length }}</span>
  </div>
</div>

<div class="app-grid" data-aos="fade-up" data-aos-delay="80">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">إضافة مستخدم جديد</h3>
        <p class="app-card__subtitle mb-0">حدد الدور والفرع لضمان منح الصلاحيات المناسبة.</p>
      </div>
    </div>
    <form method="POST" class="row g-3 text-start">
      <div class="col-md-4">
        <label class="form-label">اسم المستخدم</label>
        <input type="text" name="username" class="form-control" placeholder="مثل: ahmad.alqahtani" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">كلمة المرور</label>
        <input type="password" name="password" class="form-control" placeholder="••••••••" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">الدور الوظيفي</label>
        <select name="role" class="form-select" required>
          <option value="" disabled selected>اختر الدور</option>
          <option value="employee">موظف فرع</option>
          <option value="consulting_employee">موظف استشارات هندسية</option>
          <option value="hr">موارد بشرية</option>
          <option value="engineer">مهندس تقييم</option>
          <option value="finance">مالية</option>
          <option value="manager">مدير</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">الفرع الرئيسي</label>
        <select name="branch_id" class="form-select" required>
          <option value="" disabled selected>اختر فرعاً</option>
          {% for b in branches %}
            {% set dept_raw = (b.department or '') %}
            {% set dept_code = dept_raw|lower %}
            {% if 'consult' in dept_code or 'استشار' in dept_raw %}
              {% set dept_code = 'consultations' %}
            {% endif %}
            <option value="{{ b.id }}" data-department-code="{{ dept_code }}">{{ b.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">القسم الداخلي (اختياري)</label>
        <select name="section_id" class="form-select">
          <option value="">بدون قسم محدد</option>
          {% for b in branches %}
            {% for s in b.ordered_sections or [] %}
              {% set section_raw = (s.name or '') %}
              {% set section_code = section_raw|lower %}
              {% if 'consult' in section_code or 'استشار' in section_raw %}
                {% set section_code = 'consultations' %}
              {% endif %}
              <option value="{{ s.id }}" data-section-code="{{ section_code }}">{{ b.name }} - {{ 'الاستشارات' if s.name=='consultations' else ('التقييم' if s.name=='valuation' else s.name) }}</option>
            {% endfor %}
          {% endfor %}
        </select>
        <div class="form-text">يمكن تركه فارغاً في حال عدم الحاجة إلى تخصيص القسم.</div>
      </div>
      <div class="col-md-4">
        <label class="form-label">ربط بموظف الموارد البشرية (اختياري)</label>
        <select name="employee_id" class="form-select">
          <option value="">بدون ربط</option>
          {% for emp in hr_employees %}
            {% set assigned_user = emp.user_account %}
            <option value="{{ emp.id }}" {% if assigned_user %}disabled{% endif %}>
              {{ emp.full_name }}{% if emp.employee_number %} - {{ emp.employee_number }}{% endif %}
              {% if assigned_user %}(مربوط بـ {{ assigned_user.username }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">إنشاء الحساب</button>
      </div>
    </form>
  </div>
</div>

<div class="app-section" data-aos="fade-up" data-aos-delay="140">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">سجل المستخدمين</h3>
        <p class="app-card__subtitle mb-0">عرض تفاصيل الدخول، الأقسام، والدعوات الأخيرة.</p>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>اسم المستخدم</th>
            <th>الدور</th>
            <th>الفرع</th>
            <th>القسم</th>
            <th>الموظف المرتبط</th>
            <th class="text-center">الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td class="fw-semibold">{{ u.username }}</td>
            <td><span class="status-chip status-chip--info">{{ u.role }}</span></td>
            <td>{{ u.branch.name if u.branch else "غير محدد" }}</td>
            <td>
              {% if u.section %}
                {{ 'الاستشارات' if u.section.name=='consultations' else ('التقييم' if u.section.name=='valuation' else u.section.name) }}
              {% else %}
                <span class="text-muted">غير مرتبط</span>
              {% endif %}
            </td>
            <td>
              {% if u.employee %}
                <div class="fw-semibold">{{ u.employee.full_name }}</div>
                {% if u.employee.employee_number %}
                <div class="text-muted small">رقم الموظف: {{ u.employee.employee_number }}</div>
                {% endif %}
              {% else %}
                <span class="text-muted">لم يتم الربط</span>
              {% endif %}
              <form method="POST" class="d-flex flex-wrap gap-2 align-items-center mt-2" action="{{ url_for('link_user_to_employee', user_id=u.id) }}">
                <select name="employee_id" class="form-select form-select-sm" style="min-width: 200px;">
                  <option value="">اختر موظفاً</option>
                  {% for emp in hr_employees %}
                    {% set assigned_user = emp.user_account %}
                    <option value="{{ emp.id }}"
                      {% if u.employee and u.employee.id == emp.id %}selected{% endif %}
                      {% if assigned_user and assigned_user.id != u.id %}disabled{% endif %}>
                      {{ emp.full_name }}{% if emp.employee_number %} - {{ emp.employee_number }}{% endif %}
                      {% if assigned_user and assigned_user.id != u.id %}(مربوط بـ {{ assigned_user.username }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-primary btn-sm">تحديث الربط</button>
              </form>
              {% set invite = latest_invitations.get(u.id) %}
              {% if invite %}
              <div class="panel mt-3">
                <div class="text-muted small mb-1">رابط الدعوة</div>
                <input type="text" class="form-control form-control-sm" readonly value="{{ url_for('complete_invitation', token=invite.token, _external=True) }}">
                <div class="text-muted small mt-2">
                  كلمة المرور المؤقتة:
                  {% if invite.raw_password %}
                    <code>{{ invite.raw_password }}</code>
                  {% else %}
                    <span class="badge bg-success">تم تغييرها</span>
                  {% endif %}
                </div>
                {% if invite.used_at %}
                <div class="text-muted small mt-1">استخدمت في {{ invite.used_at.strftime('%Y-%m-%d %H:%M') }}</div>
                {% elif invite.expires_at %}
                <div class="text-muted small mt-1">تنتهي في {{ invite.expires_at.strftime('%Y-%m-%d') }}</div>
                {% endif %}
              </div>
              {% endif %}
            </td>
            <td class="text-center">
              {% if u.role != 'manager' %}
              <a href="{{ url_for('delete_employee', uid=u.id) }}" class="btn btn-outline-danger btn-sm" onclick="return confirm('هل أنت متأكد من حذف هذا الحساب؟')">حذف</a>
              {% else %}
              <span class="text-muted">غير متاح</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">لا توجد حسابات مسجلة حالياً.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const roleSelect = document.querySelector('select[name="role"]');
      const sectionSelect = document.querySelector('select[name="section_id"]');
      const branchSelect = document.querySelector('select[name="branch_id"]');

      const getSelectedCode = (selectEl, attr) => {
        if (!selectEl) {
          return null;
        }
        const option = selectEl.options[selectEl.selectedIndex];
        return option ? option.getAttribute(attr) : null;
      };

      const syncRoleWithSection = () => {
        const sectionCode = getSelectedCode(sectionSelect, 'data-section-code');
        const branchCode = getSelectedCode(branchSelect, 'data-department-code');
        const isConsulting = sectionCode === 'consultations' || branchCode === 'consultations';
        if (!roleSelect) {
          return;
        }
        if (isConsulting) {
          roleSelect.value = 'consulting_employee';
        } else if (roleSelect.value === 'consulting_employee') {
          roleSelect.value = 'employee';
        }
      };

      if (branchSelect) {
        branchSelect.addEventListener('change', syncRoleWithSection);
      }
      if (sectionSelect) {
        sectionSelect.addEventListener('change', syncRoleWithSection);
      }
      syncRoleWithSection();
    });
  </script>
{% endblock %}

