{% extends 'base.html' %}
{% from 'partials/nav.html' import manager_nav, app_nav %}
{% set title = 'حساب عمولة المنجزين' %}

{% block navbar %}
  {% if role == 'manager' %}
    {{ manager_nav(active='commissions') }}
  {% else %}
    {{ app_nav(
      brand='لوحة التقييم',
      brand_url=url_for('engineer_dashboard'),
      appearance='dark',
      collapse_id='commissionNav',
      items=[
        {'label': 'لوحة المهام', 'href': url_for('engineer_dashboard')},
        {'label': 'حساب العمولات', 'href': url_for('commissions_page'), 'active': True}
      ],
      actions=[
        {'label': 'تسجيل الخروج', 'href': url_for('logout'), 'variant': 'outline-light'}
      ]
    ) }}
  {% endif %}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>حساب عمولة المنجزين</h1>
  <div class="app-page-title__meta">
    <span>تجميع معاملات العقارات والسيارات لمعرفة العمولة المستحقة.</span>
    <span class="pill">إجمالي المعاملات المحتسبة: {{ total_count }}</span>
  </div>
</div>

{% if role == "manager" %}
<div class="app-card mb-4" data-aos="fade-up" data-aos-delay="80">
  <h3 class="app-card__title mb-3">تصفية حسب الموظف الذي جلب المعاملة</h3>
  <form method="POST" class="row g-2 align-items-end">
    <div class="col-12 col-md-6">
      <label class="form-label">اسم الموظف</label>
      <select class="form-select" name="brought_by" required>
        <option value="">اختر اسماً</option>
        {% for name in brought_by_names %}
          <option value="{{ name }}" {% if selected_brought_by and name == selected_brought_by %}selected{% endif %}>
            {{ name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <button type="submit" class="btn btn-primary w-100">تطبيق التصفية</button>
    </div>
  </form>
</div>
{% endif %}

<div class="app-grid" data-aos="fade-up" data-aos-delay="120">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">معاملات العقارات</h3>
        <p class="app-card__subtitle mb-0">كل 50 ريال عماني تحتسب معاملة واحدة.</p>
      </div>
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        عدد المعاملات المحتسبة
        <span class="fw-bold">{{ real_estate_count }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        إجمالي الدخل
        <span class="fw-bold">{{ "{:,.0f}".format(real_estate_income) }} ر.ع</span>
      </li>
    </ul>
  </div>

  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">معاملات السيارات</h3>
        <p class="app-card__subtitle mb-0">كل ثلاث سيارات تحتسب معاملة واحدة.</p>
      </div>
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        عدد السيارات المحتسبة
        <span class="fw-bold">{{ vehicle_count }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        إجمالي الدخل
        <span class="fw-bold">{{ "{:,.0f}".format(vehicle_income) }} ر.ع</span>
      </li>
    </ul>
  </div>
</div>

<div class="app-card mt-4" data-aos="fade-up" data-aos-delay="180">
  <div class="numbers-strip">
    <div class="numbers-strip__item">
      <span class="text-muted">إجمالي الدخل</span>
      <strong>{{ "{:,.0f}".format(total_income) }} ر.ع</strong>
    </div>
    <div class="numbers-strip__item">
      <span class="text-muted">إجمالي المعاملات المحتسبة</span>
      <strong>{{ total_count }}</strong>
    </div>
    <div class="numbers-strip__item">
      <span class="text-muted">العمولة المستحقة</span>
      <strong class="text-success">{{ "{:,.0f}".format(commission) }} ر.ع</strong>
      <span class="form-text">تحتسب بواقع 15 ريالاً عمانياً بعد 30 معاملة.</span>
    </div>
  </div>
  <div class="d-flex justify-content-end gap-2">
    <a href="{{ url_for('manager_dashboard') if role == 'manager' else url_for('engineer_dashboard') }}" class="btn btn-outline-primary">العودة للوحة الرئيسية</a>
  </div>
</div>
{% endblock %}
