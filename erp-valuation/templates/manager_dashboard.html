{% extends 'base.html' %}
{% from 'partials/nav.html' import manager_nav %}
{% set title = 'لوحة المدير' %}

{% block navbar %}
  {{ manager_nav(active='dashboard') }}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>لوحة القيادة</h1>
  <div class="app-page-title__meta">
    <span>متابعة سير عمليات التقييم، وحالة الفروع.</span>
    {% if transactions %}<span class="pill">عمليات جارية: {{ transactions|length }}</span>{% endif %}
    {% if branches %}<span class="pill">فروع نشطة: {{ branches|length }}</span>{% endif %}
  </div>
</div>

{% if expiring_docs and expiring_docs|length > 0 %}
<div class="app-card app-section--bordered mb-4" data-aos="fade-up" data-aos-delay="60">
  <div class="d-flex flex-column flex-md-row justify-content-between gap-2 align-items-md-center">
    <div>
      <h3 class="app-card__title mb-1">وثائق بحاجة للتجديد قريباً</h3>
      <p class="app-card__subtitle mb-0">يوجد {{ expiring_docs|length }} وثيقة تنتهي خلال أقل من 30 يوماً.</p>
    </div>
    <a href="{{ url_for('branch_documents') }}" class="btn btn-outline-primary">عرض الوثائق</a>
  </div>
</div>
{% endif %}

{% if (delayed_not_received and delayed_not_received|length) or (delayed_received_no_report and delayed_received_no_report|length) %}
<div class="app-card mb-4" data-aos="fade-up" data-aos-delay="90" style="background: linear-gradient(125deg, rgba(220, 38, 38, 0.12), rgba(249, 115, 22, 0.08));">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
    <div>
      <h3 class="app-card__title mb-2 text-danger">تنبيهات التأخير</h3>
      <p class="mb-0 text-danger">هناك معاملات متأخرة تحتاج متابعة عاجلة. راجع تفاصيلها لضمان عدم تجاوز SLA.</p>
    </div>
    <a href="{{ url_for('manager_delayed') }}" class="btn btn-danger">عرض المعاملات المتأخرة</a>
  </div>
</div>
{% endif %}

<div class="stats-row" data-aos="fade-up" data-aos-delay="120">
  <div class="stat-card">
    <span class="stat-card__label">إجمالي قيمة التقديرات</span>
    <span class="stat-card__value">
      {{ '{:,.0f}'.format(transactions|sum(attribute='total_estimate') if transactions else 0) }} ر.ع
    </span>
    <div class="text-muted small">إجمالي التقديرات للعمليات الحالية.</div>
  </div>
  <div class="stat-card">
    <span class="stat-card__label">المعاملات في طور الإنجاز</span>
    <span class="stat-card__value">{{ transactions|length or 0 }}</span>
    <div class="text-muted small">يتضمن المعاملات الجارية في كافة الفروع.</div>
  </div>
  <div class="stat-card">
    <span class="stat-card__label">إجمالي الدخل للفروع</span>
    <span class="stat-card__value">
      {{ '{:,.0f}'.format(branches|sum(attribute='income') if branches else 0) }} ر.ع
    </span>
    <div class="text-muted small">القيمة الصافية المجمعة لجميع الفروع.</div>
  </div>
</div>

<div class="app-section" data-aos="fade-up" data-aos-delay="150">
  <div class="section-title">المعاملات الجارية</div>
  {% if transactions %}
  <div class="app-grid app-grid--two">
    {% for t in transactions %}
    <div class="app-card d-grid gap-3" data-aos="fade-up" data-aos-delay="{{ loop.index * 40 }}">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3 class="app-card__title mb-1">{{ t.client }}</h3>
          <p class="app-card__subtitle mb-0">{{ t.bank.name if t.bank else 'بنك غير محدد' }}</p>
        </div>
        <span class="badge bg-soft-primary">{{ t.status }}</span>
      </div>
      <div class="d-grid gap-1">
        <div class="text-muted small">الموظف المسؤول: <span class="fw-semibold">{{ t.employee }}</span></div>
        <div class="text-muted small">الموقع: {{ t.state }} - {{ t.region }}</div>
        <div class="text-muted small">تاريخ الطلب: {{ t.date.strftime('%Y-%m-%d') }}</div>
      </div>
      <div class="panel">
        <div class="d-flex flex-wrap gap-3">
          <div>
            <div class="text-muted small mb-1">مساحة الأرض</div>
            <strong>{{ '{:,.0f}'.format(t.area) }} م²</strong>
          </div>
          <div>
            <div class="text-muted small mb-1">قيمة الأرض</div>
            <strong>{{ '{:,.0f}'.format(t.land_value) }} ر.ع</strong>
          </div>
          <div>
            <div class="text-muted small mb-1">قيمة المبنى</div>
            <strong>{{ '{:,.0f}'.format(t.building_value) }} ر.ع</strong>
          </div>
          <div>
            <div class="text-muted small mb-1">أتعاب التقييم</div>
            <strong>{{ '{:,.0f}'.format(t.fee) }} ر.ع</strong>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <h4>لا توجد معاملات حالية</h4>
    <p>عند إضافة معاملات جديدة ستظهر هنا للمتابعة الفورية.</p>
    <a href="{{ url_for('manage_branches') }}" class="btn btn-primary">الانتقال لإدارة الفروع</a>
  </div>
  {% endif %}
</div>

<div class="app-section" data-aos="fade-up" data-aos-delay="180">
  <div class="section-title">ملخص أداء الفروع</div>
  {% if branches %}
  <div class="app-grid app-grid--three">
    {% for branch in branches %}
    <a href="{{ url_for('manager_branch_summary', bid=branch.id) }}" class="text-decoration-none text-reset">
      <div class="app-card d-grid gap-2" data-aos="fade-up" data-aos-delay="{{ loop.index * 30 }}">
        <h3 class="app-card__title mb-0">{{ branch.name }}</h3>
        <div class="text-muted small">إجمالي الدخل</div>
        <strong>{{ '{:,.0f}'.format(branch.income) }} ر.ع</strong>
        <div class="text-muted small">إجمالي المصروفات</div>
        <strong>{{ '{:,.0f}'.format(branch.expenses) }} ر.ع</strong>
        <div class="status-chip status-chip--success mt-2">الربح الصافي: {{ '{:,.0f}'.format(branch.profit) }} ر.ع</div>
      </div>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <h4>لا توجد بيانات فروع</h4>
    <p>قم بإضافة الفروع أو ربطها لعرض مؤشرات الأداء.</p>
    <a href="{{ url_for('manage_branches') }}" class="btn btn-outline-primary">إدارة الفروع</a>
  </div>
  {% endif %}
</div>
{% endblock %}
