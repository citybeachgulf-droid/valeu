{% extends 'base.html' %}
{% from 'partials/nav.html' import manager_nav, finance_nav, app_nav %}
{% set title = 'إدارة العملاء' %}

{% block navbar %}
  {% set current_role = session.get('role') %}
  {% if current_role == 'manager' %}
    {{ manager_nav(active='customers') }}
  {% elif current_role == 'finance' %}
    {{ finance_nav(active='customers') }}
  {% else %}
    {{ app_nav(
      brand='لوحة العملاء',
      brand_url=url_for('customers_page'),
      appearance='dark',
      collapse_id='customersNav',
      items=[{'label': 'سجل العملاء', 'href': url_for('customers_page'), 'active': True}],
      actions=[{'label': 'تسجيل الخروج', 'href': url_for('logout'), 'variant': 'outline-light'}]
    ) }}
  {% endif %}
{% endblock %}

{% block content %}
<div class="app-page-title" data-aos="fade-up">
  <h1>إدارة بيانات العملاء</h1>
  <div class="app-page-title__meta">
    <span>إضافة عملاء جدد والبحث في السجل الحالي.</span>
    <span class="pill">إجمالي العملاء: {{ customers|length }}</span>
  </div>
</div>

<div class="app-toolbar" data-aos="fade-up" data-aos-delay="60">
  <form method="get" class="app-filter align-items-end">
    <div>
      <label class="form-label">ابحث عن عميل</label>
      <input type="text" name="q" class="form-control" value="{{ q or '' }}" placeholder="اكتب اسم العميل أو رقمه">
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary">بحث</button>
      <a href="{{ url_for('customers_page') }}" class="btn btn-light">إعادة التعيين</a>
      <a href="{{ url_for('customers_export_csv', q=q) }}" class="btn btn-outline-primary">تصدير CSV</a>
    </div>
  </form>
</div>

{% set latest_customer = customers|first if customers else None %}

{% if q %}
<div class="app-card app-card__subtitle mb-4 text-muted" data-aos="fade-up" data-aos-delay="80">
  نتائج البحث عن: <strong>{{ q }}</strong>
</div>
{% endif %}

{% if customers %}
<div class="numbers-strip" data-aos="fade-up" data-aos-delay="90">
  <div class="numbers-strip__item">
    <span>عدد النتائج الحالية</span>
    <strong>{{ customers|length }}</strong>
  </div>
  {% if q %}
  <div class="numbers-strip__item">
    <span>حالة البحث</span>
    <strong>تصفية مفعّلة</strong>
    <small class="text-muted">استخدم إعادة التعيين للعودة إلى القائمة الكاملة.</small>
  </div>
  {% endif %}
  {% if latest_customer %}
  <div class="numbers-strip__item">
    <span>أحدث إضافة</span>
    <strong>{{ latest_customer.name }}</strong>
    <small class="text-muted">الرقم: {{ latest_customer.phone }}</small>
  </div>
  {% endif %}
</div>
{% endif %}

<div class="app-grid app-grid--two" data-aos="fade-up" data-aos-delay="110">
  <div class="app-card">
    <div class="app-card__header">
      <div>
        <h3 class="app-card__title">إضافة عميل جديد</h3>
        <p class="app-card__subtitle mb-0">أضف بيانات التواصل ليتمكن الفريق من المتابعة.</p>
      </div>
    </div>
    <form method="post" action="{{ url_for('customers_page') }}" class="d-grid gap-3 text-start">
      <div>
        <label class="form-label">اسم العميل</label>
        <input type="text" name="name" class="form-control" placeholder="مثل: شركة التنمية العقارية" required>
      </div>
      <div>
        <label class="form-label">رقم التواصل</label>
        <input type="text" name="phone" class="form-control" placeholder="05XXXXXXXX" required>
      </div>
      <button class="btn btn-primary" type="submit">حفظ العميل</button>
    </form>
  </div>

  <div class="app-card">
    <div class="app-card__header">
      <h3 class="app-card__title mb-0">سجل العملاء</h3>
    </div>
    {% if customers %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>الاسم</th>
            <th>رقم التواصل</th>
            <th class="text-center">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for c in customers %}
          <tr>
            <td>{{ c.id }}</td>
            <td class="fw-semibold">{{ c.name }}</td>
            <td>
              <span class="badge bg-soft-primary">{{ c.phone }}</span>
            </td>
            <td class="text-center">
              <div class="d-flex gap-2 justify-content-center flex-wrap">
                <a class="btn btn-sm btn-outline-primary" href="tel:{{ c.phone }}">اتصال</a>
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="if (!navigator.clipboard) { alert('انسخ الرقم يدوياً: {{ c.phone }}'); return; } const btn = this; navigator.clipboard.writeText('{{ c.phone }}').then(function () { btn.textContent = 'تم النسخ'; setTimeout(function () { btn.textContent = 'نسخ الرقم'; }, 2000); }).catch(function () { btn.textContent = 'تعذّر النسخ'; setTimeout(function () { btn.textContent = 'نسخ الرقم'; }, 2000); });">
                  نسخ الرقم
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <h4>لا توجد بيانات مطابقة</h4>
      <p>لم يتم العثور على عملاء يطابقون البحث الحالي. جرّب كلمات مفتاحية مختلفة أو أعد التعيين.</p>
      <a href="{{ url_for('customers_page') }}" class="btn btn-outline-primary">عرض جميع العملاء</a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
