<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
<style>
  body { font-family: 'Cairo', sans-serif; background: #f5f7fa; }
  h2 { font-weight: 700; margin-bottom: 1.5rem; }
  .navbar { background: linear-gradient(90deg,#0d6efd,#6610f2); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  .card { border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 25px; transition: transform 0.3s; }
  .card:hover { transform: translateY(-5px); }
  .card-header { font-weight: 700; font-size: 1.1rem; background: linear-gradient(90deg,#6610f2,#0d6efd); color: #fff; }
  .btn-primary, .btn-success, .btn-outline-primary, .btn-outline-secondary { border-radius: 50px; transition: 0.3s; }
  .btn-primary:hover { background: #6610f2; border-color: #6610f2; }
  .form-label { font-weight: 600; }
  ul { padding-left: 1.2rem; }
  li a { text-decoration: none; transition: 0.2s; }
  li a:hover { color: #6610f2; }
  .badge-status { font-size: 0.9rem; padding: 0.5em 0.75em; border-radius: 12px; }
  .tab-card { border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
  @media(max-width:768px){ .navbar-nav { text-align: center; } }
</style>
</head>
<body class="container mt-4" data-back-button-label="{{ role_home_label }}" data-back-button-fallback="{{ role_home_url }}">

<nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow-sm" data-aos="fade-down">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">ğŸ› ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('engineer_dashboard') }}">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li class="nav-item"><a class="nav-link text-warning" href="/reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
        <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('logout') }}">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
      </ul>
    </div>
  </div>
</nav>

<h2 data-aos="fade-up">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© #{{ t.id }}</h2>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="card" data-aos="fade-up">
  <div class="card-header">ğŸ“Œ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
  <div class="card-body">
    <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ t.client }}</p>
    <p><strong>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¯Ø®Ù„:</strong> {{ t.employee }}</p>
    <p><strong>Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</strong> {{ t.brought_by or '-' }}</p>
    <p><strong>Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</strong> {{ t.visited_by or '-' }}</p>
    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ t.date.strftime("%Y-%m-%d %H:%M") }}</p>
    <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> {{ t.branch.name if t.branch else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</p>
    <p><strong>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span class="badge bg-info text-dark">{{ t.status }}</span></p>
  </div>
</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø± -->
{% if t.transaction_type == "real_estate" %}
<div class="card" data-aos="fade-up">
  <div class="card-header bg-success text-white">ğŸ  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø§Ø±</div>
  <div class="card-body">
    <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> {{ t.state }}</p>
    <p><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> {{ t.region }}</p>
    <p><strong>Ø§Ù„Ø¨Ù†Ùƒ:</strong> {{ t.bank.name if t.bank else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</p>
    <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> {{ t.area }} Ù…Â²</p>
    <p><strong>Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> {{ t.building_area }} Ù…Â²</p>
    <p><strong>Ø¹Ù…Ø± Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> {{ t.building_age }} Ø³Ù†Ø©</p>
    <p><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø±Ø¶:</strong> {{ "{:,.0f}".format(t.land_value or 0) }} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> {{ "{:,.0f}".format(t.building_value or 0) }} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ«Ù…ÙŠÙ†:</strong> <span class="fw-bold text-success">{{ "{:,.0f}".format(t.total_estimate or 0) }}</span> Ø±ÙŠØ§Ù„</p>

    {% if session.get('role') == 'engineer' %}
    <hr>
    <form method="POST" action="{{ url_for('engineer_valuate_transaction', tid=t.id) }}" class="row g-3">
      <div class="col-md-4"><label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø±Ø¶</label><input type="number" step="0.01" name="land_value" class="form-control" value="{{ t.land_value or 0 }}" required></div>
      <div class="col-md-4"><label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input type="number" step="0.01" name="building_value" class="form-control" value="{{ t.building_value or 0 }}"></div>
      <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ«Ù…ÙŠÙ†</button></div>
    </form>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
{% if t.transaction_type == "vehicle" %}
<div class="card" data-aos="fade-up">
  <div class="card-header bg-warning">ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</div>
  <div class="card-body">
    <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> {{ t.vehicle_type }}</p>
    <p><strong>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</strong> {{ t.vehicle_model }}</p>
    <p><strong>Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹:</strong> {{ t.vehicle_year }}</p>
    <p><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</strong> <span class="fw-bold text-success">{{ t.total_estimate }}</span> Ø±ÙŠØ§Ù„</p>

    {% if session.get('role') == 'engineer' %}
    <hr>
    <form method="POST" action="{{ url_for('engineer_valuate_transaction', tid=t.id) }}" class="row g-3">
      <div class="col-md-6"><label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><input type="number" step="0.01" name="vehicle_value" class="form-control" value="{{ t.total_estimate or '' }}" required></div>
      <div class="col-md-6 d-flex align-items-end"><button class="btn btn-primary w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ«Ù…ÙŠÙ†</button></div>
    </form>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© -->
<div class="card" data-aos="fade-up">
  <div class="card-header bg-dark text-white">ğŸ“‚ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</div>
  <div class="card-body">
    {% if t.files %}
    <ul class="list-group list-group-flush">
      {% for f in t.files.split(",") %}
        {% set name = f %}
        {% set ext = (name.rsplit('.', 1)[1] | lower) if (name and '.' in name) else '' %}
        {% set office_exts = ['doc','docx','xls','xlsx','ppt','pptx'] %}
        {% set src = url_for('uploaded_file', filename=f, _external=True) %}
        {% set view_href = ('https://view.officeapps.live.com/op/view.aspx?src=' ~ (src | urlencode)) if ext in office_exts else src %}
        <li class="list-group-item"><a href="{{ view_href }}" target="_blank">{{ f }}</a></li>
      {% endfor %}
    </ul>
    {% else %}
    <p>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª</p>
    {% endif %}
  </div>
</div>

{% if session.get('role') == 'engineer' and (t.status == 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³' or t.status == 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³') %}
<div class="mb-3" data-aos="fade-up">
  <a href="{{ url_for('engineer_take', tid=t.id) }}" class="btn btn-primary w-100">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</a>
</div>
{% endif %}

<!-- Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± -->
<div class="card" data-aos="fade-up">
  <div class="card-header bg-info text-white">ğŸ“‘ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ±</div>
  <div class="card-body">
    <form action="{{ url_for('engineer_upload_report', tid=t.id) }}" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="report_file" class="form-label">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF ÙÙ‚Ø·):</label>
        <input type="file" class="form-control" name="report_file" accept=".pdf" required>
      </div>
      <button type="submit" class="btn btn-success w-100">â¬†ï¸ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      {% if t.report_sha256 %}
      <a class="btn btn-outline-primary mt-2 w-100" href="{{ url_for('barcode_page') }}?hash={{ t.report_sha256 }}" target="_blank">ğŸ§¾ Ø¹Ø±Ø¶ QR ÙˆØ§Ù„ØªØ­Ù‚Ù‚</a>
      {% endif %}
    </form>
  </div>
</div>

<a href="{{ url_for('engineer_dashboard') }}" class="btn btn-secondary w-100 mb-4" data-aos="fade-up">ğŸ”™ Ø±Ø¬ÙˆØ¹</a>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script>
  AOS.init({ duration: 800, once: true });
</script>
  <script defer src="{{ url_for('static', filename='js/back-button.js') }}"></script>
</body>
</html>
