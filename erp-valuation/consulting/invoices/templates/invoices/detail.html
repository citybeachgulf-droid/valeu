{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© #{{ invoice.id }}</h3>
    <a href="{{ url_for('consulting_invoices.list_invoices') }}" class="btn btn-secondary">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h5>
          <div class="mb-2"><strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> {{ invoice.project.name if invoice.project else '-' }}</div>
          <div class="mb-2"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ invoice.client.name if invoice.client else '-' }}</div>
          <div class="mb-2"><strong>Ø§Ù„Ø¹Ù‚Ø¯:</strong> {{ invoice.contract.contract_number if invoice.contract else 'â€”' }}</div>
          <div class="mb-2"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ '%.2f'|format(invoice.amount) }}</div>
          <div class="mb-2"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> {{ invoice.issue_date.strftime('%Y-%m-%d') if invoice.issue_date else '-' }}</div>
          <div class="mb-2"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</strong> {{ invoice.due_date.strftime('%Y-%m-%d') if invoice.due_date else '-' }}
            {% if invoice.is_overdue() %}
              <span class="badge bg-danger ms-1">Ù…ØªØ£Ø®Ø±Ø©</span>
            {% endif %}
          </div>
          <div class="mb-2"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ invoice.status }}</div>
          <div class="mb-2"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯:</strong> {{ invoice.paid_date.strftime('%Y-%m-%d') if invoice.paid_date else 'â€”' }}</div>
          <div class="mb-0"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong><br>{{ invoice.notes or 'â€”' }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</h5>
          <form method="post" action="{{ url_for('consulting_invoices.update_invoice_status', invoice_id=invoice.id) }}" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select name="status" class="form-select">
                {% for s in INVOICE_STATUSES %}
                  <option value="{{ s }}" {% if invoice.status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input type="date" name="paid_date" class="form-control" value="{{ invoice.paid_date.strftime('%Y-%m-%d') if invoice.paid_date else '' }}">
              <div class="form-text">Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "Ù…Ø¯ÙÙˆØ¹Ø©" ÙˆÙ„Ù… ØªØ¯Ø®Ù„ ØªØ§Ø±ÙŠØ®Ù‹Ø§ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….</div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
          </form>
        </div>
      </div>
      
      {% if linked_finance_invoices %}
      <div class="card mt-3">
        <div class="card-body">
          <h5 class="card-title mb-3">ğŸ”— Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                {% for fin_inv in linked_finance_invoices %}
                <tr>
                  <td>{{ fin_inv.invoice_number or ('INV-CUST-' ~ fin_inv.id) }}</td>
                  <td>{{ fin_inv.customer_name }}</td>
                  <td>{{ '%.2f'|format(fin_inv.amount) }}</td>
                  <td>{{ fin_inv.issued_at.strftime('%Y-%m-%d') if fin_inv.issued_at else '-' }}</td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('print_customer_invoice_html', invoice_id=fin_inv.id) }}" target="_blank">Ø¹Ø±Ø¶</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
