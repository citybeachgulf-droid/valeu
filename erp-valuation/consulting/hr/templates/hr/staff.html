{% extends 'base.html' %}

{% block content %}
<style>
/* ===== اتجاه وخط الصفحة ===== */
body {
  direction: rtl;
  text-align: right;
  font-family: 'Tajawal', sans-serif;
}

/* ===== الحاوية ===== */
.container {
  max-width: 1200px;
  padding: 2rem 1rem;
}

/* ===== العناوين والأزرار ===== */
h3 {
  font-weight: 600;
  color: #4a148c;
}
.btn-primary, .btn-outline-secondary {
  border-radius: 8px;
  transition: 0.3s;
}
.btn-primary:hover {
  background-color: #5a32a3;
}
.btn-outline-secondary:hover {
  background-color: #f8f9fa;
  color: #000;
}

/* ===== نموذج البحث ===== */
.form-control, .form-select {
  border-radius: 8px;
  padding: 0.5rem 0.75rem;
}

/* ===== بطاقات الأقسام ===== */
.card {
  border-radius: 10px;
  margin-bottom: 1.5rem;
}
.card-header {
  background-color: #6f42c1;
  color: #fff;
  font-weight: 600;
}
.card-body {
  padding: 1rem;
}

/* ===== جداول الموظفين والمهندسين ===== */
.table thead {
  background-color: #f5f5f5;
}
.table tbody tr:hover {
  background-color: #fdfcff;
}
.badge {
  padding: 0.4em 0.6em;
  font-size: 0.85rem;
  border-radius: 0.5rem;
}

/* ===== أزرار العمليات ===== */
.btn-sm {
  padding: 0.25rem 0.5rem;
}

/* ===== تنسيقات إضافية ===== */
.text-muted {
  font-size: 0.9rem;
}
</style>

<div class="container py-4">
  <!-- رأس الصفحة -->
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
    <div>
      <h3>الموظفين والمهندسين</h3>
      <p class="text-muted small mb-0">عرض وإدارة بيانات جميع الموظفين والمهندسين</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.dashboard') }}">لوحة HR</a>
      {% if can_manage %}
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.create_employee') }}">إضافة موظف</a>
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.create_engineer') }}">إضافة مهندس</a>
      {% endif %}
    </div>
  </div>

  <!-- نموذج البحث والفلاتر -->
  <form class="row g-2 mb-3" method="get">
    <div class="col-md-3">
      <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="ابحث باسم الموظف أو الرقم الوظيفي">
    </div>
    <div class="col-md-2">
      <select class="form-select" name="department_id">
        <option value="">كل الأقسام</option>
        {% for dept in departments %}
        <option value="{{ dept.id }}" {% if current_department_id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="employee_status">
        <option value="">حالة الموظف</option>
        {% for st in EMPLOYEE_STATUSES %}
        <option value="{{ st }}" {% if current_employee_status == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="engineer_status">
        <option value="">حالة المهندس</option>
        {% for st in ENGINEER_STATUSES %}
        <option value="{{ st }}" {% if current_engineer_status == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-grid">
      <button class="btn btn-primary" type="submit">بحث</button>
      <a href="{{ url_for('consulting_hr.list_staff') }}" class="btn btn-outline-secondary btn-sm mt-1">إعادة تعيين</a>
    </div>
  </form>

  <!-- عرض الموظفين والمهندسين حسب الأقسام -->
  {% if staff_by_department %}
    {% for dept_name, staff_data in staff_by_department.items() %}
    <div class="card shadow-sm border-0">
      <div class="card-header">
        {{ dept_name }}
        <span class="badge bg-light text-dark ms-2">
          {{ staff_data.employees|length }} موظف{% if staff_data.employees|length != 1 %}ين{% endif %}
          {% if staff_data.engineers|length > 0 %}
            | {{ staff_data.engineers|length }} مهندس{% if staff_data.engineers|length != 1 %}ين{% endif %}
          {% endif %}
        </span>
      </div>
      <div class="card-body">

        <!-- جدول الموظفين -->
        {% if staff_data.employees %}
        <h6 class="text-muted mb-3">الموظفين ({{ staff_data.employees|length }})</h6>
        <div class="table-responsive mb-4">
          <table class="table table-striped table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>الرقم الوظيفي</th>
                <th>الاسم</th>
                <th>المسمى الوظيفي</th>
                <th>البريد الإلكتروني</th>
                <th>الهاتف</th>
                <th>تاريخ الانضمام</th>
                <th>الحالة</th>
                <th>عمليات</th>
              </tr>
            </thead>
            <tbody>
              {% for emp in staff_data.employees %}
              <tr>
                <td>{{ emp.employee_number or '-' }}</td>
                <td><strong>{{ emp.full_name }}</strong></td>
                <td>{{ emp.job_title or emp.position or '-' }}</td>
                <td>{{ emp.email or '-' }}</td>
                <td>{{ emp.phone or emp.mobile or '-' }}</td>
                <td>{% if emp.join_date %}{{ emp.join_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                <td>
                  <span class="badge {% if emp.status == 'نشط' %}bg-success{% elif emp.status == 'إجازة' %}bg-warning{% else %}bg-secondary{% endif %}">
                    {{ emp.status }}
                  </span>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('consulting_hr.employee_detail', employee_id=emp.id) }}">عرض</a>
                    {% if can_manage %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('consulting_hr.edit_employee', employee_id=emp.id) }}">تعديل</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <!-- جدول المهندسين -->
        {% if staff_data.engineers %}
        <h6 class="text-muted mb-3">المهندسين ({{ staff_data.engineers|length }})</h6>
        <div class="table-responsive">
          <table class="table table-striped table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>الاسم</th>
                <th>التخصص</th>
                <th>الهاتف</th>
                <th>البريد الإلكتروني</th>
                <th>تاريخ الانضمام</th>
                <th>الحالة</th>
                <th>المهام المفتوحة</th>
                <th>المهام المتأخرة</th>
                <th>عمليات</th>
              </tr>
            </thead>
            <tbody>
              {% for eng in staff_data.engineers %}
              <tr>
                <td><strong>{{ eng.name }}</strong></td>
                <td>{{ eng.specialty }}</td>
                <td>{{ eng.phone or '-' }}</td>
                <td>{{ eng.email or '-' }}</td>
                <td>{% if eng.join_date %}{{ eng.join_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                <td>
                  <span class="badge {% if eng.status=='نشط' %}bg-success{% else %}bg-secondary{% endif %}">{{ eng.status }}</span>
                </td>
                <td>{{ open_counts.get(eng.id, 0) }}</td>
                <td>
                  {% set oc = overdue_counts.get(eng.id, 0) %}
                  <span class="badge {{ 'bg-danger' if oc>0 else 'bg-success' }}">{{ oc }}</span>
                </td>
                <td>
                  <div class="d-flex gap-1">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('consulting_hr.engineer_detail', engineer_id=eng.id) }}">عرض</a>
                    {% if can_manage %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('consulting_hr.edit_engineer', engineer_id=eng.id) }}">تعديل</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        {% if not staff_data.employees and not staff_data.engineers %}
        <div class="text-center text-muted py-4">
          لا يوجد موظفين أو مهندسين في هذا القسم.
        </div>
        {% endif %}

      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info text-center">
      لا توجد بيانات للموظفين أو المهندسين.
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
