{% extends 'base.html' %}

{% block title %}Ù„ÙˆØ­Ø© Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- ===== Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h3 class="mb-1">Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
      <p class="text-muted mb-0 small">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.list_engineers') }}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_projects.list_projects') }}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a>
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.create_engineer') }}">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯</a>
    </div>
  </div>

  <!-- ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© ===== -->
  <div class="row g-3">
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</div>
        <div class="fs-3 fw-bold">{{ stats.total_engineers }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
        <div class="fs-3 fw-bold text-success">{{ stats.active_engineers }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
        <div class="fs-3 fw-bold text-secondary">{{ stats.inactive_engineers }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div>
        <div class="fs-3 fw-bold">{{ stats.total_open_tasks }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
        <div class="fs-3 fw-bold text-danger">{{ stats.overdue_tasks_count }}</div>
      </div>
    </div>
  </div>

  <!-- ===== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== -->
  <div class="row g-4 mt-1">
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯ -->
    <div class="col-lg-5">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-white fw-semibold">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯</div>
        <div class="card-body">
          <form method="post" novalidate>
            <div class="mb-3">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</label>
              <input type="text" class="form-control {% if form_errors.get('name') %}is-invalid{% endif %}" name="name" value="{{ form_values.name }}" required>
              {% if form_errors.get('name') %}<div class="invalid-feedback d-block">{{ form_errors.get('name') }}</div>{% endif %}
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Ø§Ù„ØªØ®ØµØµ</label>
                <select class="form-select {% if form_errors.get('specialty') %}is-invalid{% endif %}" name="specialty" required>
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ --</option>
                  {% for sp in ENGINEER_SPECIALTIES %}
                    <option value="{{ sp }}" {% if form_values.specialty==sp %}selected{% endif %}>{{ sp }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select class="form-select" name="status">
                  {% for st in ENGINEER_STATUSES %}
                    <option value="{{ st }}" {% if form_values.status==st %}selected{% endif %}>{{ st }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" class="form-control" name="phone" value="{{ form_values.phone }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" class="form-control" name="email" value="{{ form_values.email }}">
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</label>
              <input type="date" class="form-control" name="join_date" value="{{ form_values.join_date }}">
            </div>

            <div class="d-grid mt-4">
              <button class="btn btn-primary" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† -->
    <div class="col-lg-7">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ</h5>
          {% if specialty_distribution %}
            <div class="d-flex flex-wrap gap-2">
              {% for name, count in specialty_distribution.items() %}
                <span class="badge bg-light text-dark border">{{ name }} <span class="ms-1 fw-semibold">{{ count }}</span></span>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          {% endif %}
        </div>
        <div class="card-footer bg-white">
          <h6 class="mb-2">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø§Ù„Ù…Ø¶Ø§ÙÙŠÙ†</h6>
          {% if recent_engineers %}
            <ul class="list-unstyled mb-0 small">
              {% for eng in recent_engineers %}
              <li class="mb-1">
                <span class="fw-semibold">{{ eng.name }}</span> â€“ {{ eng.specialty }}
                {% if eng.created_at %}<span class="text-muted">({{ eng.created_at.strftime('%Y-%m-%d') }})</span>{% endif %}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÙˆÙ† Ù…Ø¶Ø§ÙÙˆÙ† Ù…Ø¤Ø®Ø±Ø§Ù‹.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Ø§Ù„Ù…Ù‡Ø§Ù… ===== -->
  <div class="row g-4 mt-1">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        <div class="card-body">
          {% if upcoming_tasks %}
          <ul class="list-group list-group-flush">
            {% for task in upcoming_tasks %}
            <li class="list-group-item">
              <div class="fw-semibold">{{ task.title }}</div>
              <div class="text-muted small">
                {{ task.engineer.name if task.engineer else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                {% if task.deadline %} â€¢ Ø§Ù„Ù…ÙˆØ¹Ø¯: {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
              </div>
              {% if task.project %}<div class="text-muted small">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {{ task.project.name }}</div>{% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù‚Ø§Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
        <div class="card-body">
          {% if overdue_tasks %}
          <ul class="list-group list-group-flush">
            {% for task in overdue_tasks %}
            <li class="list-group-item list-group-item-danger">
              <div class="fw-semibold">{{ task.title }}</div>
              <div class="text-muted small">
                {{ task.engineer.name if task.engineer else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                {% if task.deadline %} â€¢ ØªØ£Ø®Ø±Øª Ù…Ù†Ø° {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
              </div>
              {% if task.project %}<div class="text-muted small">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {{ task.project.name }}</div>{% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‡Ø§Ù… ===== -->
  <div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-white fw-semibold">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
    <div class="card-body">
      {% if recent_tasks %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ù…Ù‡Ù…Ø©</th>
              <th>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody>
            {% for task in recent_tasks %}
            <tr>
              <td>{{ task.title }}</td>
              <td>{{ task.engineer.name if task.engineer else '-' }}</td>
              <td>
                <span class="badge 
                  {% if task.status == 'Ù…Ù†Ø¬Ø²Ø©' %}bg-success
                  {% elif task.status == 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' %}bg-info text-dark
                  {% else %}bg-secondary{% endif %}">
                  {{ task.status }}
                </span>
              </td>
              <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at else '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
