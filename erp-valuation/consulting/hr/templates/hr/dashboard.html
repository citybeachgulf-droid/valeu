{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- ===== Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h3 class="mb-1">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h3>
      <p class="text-muted mb-0 small">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.list_staff') }}">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</a>
      {% if session.get('role') in ['manager', 'hr', 'hr_manager'] %}
      <a class="btn btn-outline-primary" href="{{ url_for('manage_employees') }}">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
      {% endif %}
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.create_employee') }}">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</a>
    </div>
  </div>

  <!-- ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© ===== -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="fs-3 fw-bold">{{ stats.total_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
        <div class="fs-3 fw-bold text-success">{{ stats.active_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©</div>
        <div class="fs-3 fw-bold text-warning">{{ stats.on_leave_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„Ø­Ø¶ÙˆØ± (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</div>
        <div class="fs-3 fw-bold text-info">{{ stats.present_count }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„ØºÙŠØ§Ø¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</div>
        <div class="fs-3 fw-bold text-danger">{{ stats.absent_count }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
        <div class="fs-3 fw-bold">{{ stats.pending_leaves }}</div>
      </div>
    </div>
  </div>

  <!-- ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ===== -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">ÙƒØ´ÙˆÙ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</div>
        <div class="fs-4 fw-bold">{{ stats.current_month_payroll }}</div>
        {% if stats.total_payroll_amount > 0 %}
        <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ "{:,.0f}".format(stats.total_payroll_amount) }} Ø±.Ø¹</div>
        {% endif %}
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</div>
        <div class="fs-4 fw-bold text-warning">{{ stats.expiring_documents }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ</div>
        <div class="fs-4 fw-bold">{{ stats.pending_applications }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</div>
        <div class="fs-4 fw-bold">{{ stats.total_engineers }}</div>
      </div>
    </div>
  </div>

  <!-- ===== ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===== -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
    </div>
    <div class="card-body">
      {% if department_distribution %}
        <div class="d-flex flex-wrap gap-3">
          {% for dept_name, count in department_distribution.items() %}
          <div class="text-center p-3 bg-light rounded">
            <div class="fs-4 fw-bold text-primary">{{ count }}</div>
            <div class="text-muted small">{{ dept_name }}</div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted text-center py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>
      {% endif %}
    </div>
  </div>

  <!-- ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ Ù‚Ø³Ù… ===== -->
  {% if department_stats %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø© Ù„ÙƒÙ„ Ù‚Ø³Ù…</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th class="text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</th>
              <th class="text-center">Ù†Ø´Ø·</th>
              <th class="text-center">ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©</th>
              <th class="text-center">Ø­Ø§Ø¶Ø± (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</th>
              <th class="text-center">ØºØ§Ø¦Ø¨ (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</th>
              <th class="text-center">Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</th>
            </tr>
          </thead>
          <tbody>
            {% for dept_stat in department_stats %}
            <tr>
              <td>
                <strong>{{ dept_stat.department.name }}</strong>
                {% if dept_stat.department.code %}
                <span class="text-muted small">({{ dept_stat.department.code }})</span>
                {% endif %}
              </td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ dept_stat.total_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-success">{{ dept_stat.active_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-warning text-dark">{{ dept_stat.on_leave_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-info">{{ dept_stat.present_count }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-danger">{{ dept_stat.absent_count }}</span>
              </td>
              <td class="text-center">
                {% if dept_stat.pending_leaves > 0 %}
                <span class="badge bg-warning text-dark">{{ dept_stat.pending_leaves }}</span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== Ø£Ø­Ø¯Ø« Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ===== -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø¶Ø§ÙÙŠÙ†</div>
        <div class="card-body">
          {% if recent_employees %}
          <ul class="list-group list-group-flush">
            {% for emp in recent_employees %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ emp.full_name }}</div>
                  <div class="text-muted small">
                    {% if emp.department %}{{ emp.department.name }} â€¢ {% endif %}
                    {% if emp.job_title %}{{ emp.job_title }}{% endif %}
                  </div>
                  {% if emp.created_at %}
                  <div class="text-muted small">{{ emp.created_at.strftime('%Y-%m-%d') }}</div>
                  {% endif %}
                </div>
                <span class="badge bg-{% if emp.status == 'Ù†Ø´Ø·' %}success{% else %}secondary{% endif %}">
                  {{ emp.status }}
                </span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted text-center py-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø¶Ø§ÙÙˆÙ† Ù…Ø¤Ø®Ø±Ø§Ù‹</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
        <div class="card-body">
          {% if upcoming_leaves %}
          <ul class="list-group list-group-flush">
            {% for leave in upcoming_leaves %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ leave.employee.full_name if leave.employee else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                  <div class="text-muted small">
                    {% if leave.leave_type %}{{ leave.leave_type.name }} â€¢ {% endif %}
                    {{ leave.start_date.strftime('%Y-%m-%d') }} Ø¥Ù„Ù‰ {{ leave.end_date.strftime('%Y-%m-%d') }}
                  </div>
                  <div class="text-muted small">{{ leave.total_days }} ÙŠÙˆÙ…</div>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted text-center py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ===== -->
  {% if docs_expiring_soon %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0 text-warning">âš ï¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹ (Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
              <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in docs_expiring_soon %}
            <tr>
              <td>{{ doc.employee.full_name if doc.employee else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
              <td>{{ doc.document_type }}</td>
              <td>{{ doc.document_name }}</td>
              <td>{{ doc.expiry_date.strftime('%Y-%m-%d') if doc.expiry_date else '-' }}</td>
              <td>
                {% set days = doc.days_until_expiry() %}
                {% if days is not none %}
                  {% if days < 0 %}
                  <span class="badge bg-danger">Ù…Ù†ØªÙ‡ÙŠ</span>
                  {% elif days <= 7 %}
                  <span class="badge bg-danger">{{ days }} ÙŠÙˆÙ…</span>
                  {% elif days <= 15 %}
                  <span class="badge bg-warning text-dark">{{ days }} ÙŠÙˆÙ…</span>
                  {% else %}
                  <span class="badge bg-info">{{ days }} ÙŠÙˆÙ…</span>
                  {% endif %}
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆØ§Ù„Ù…Ù‡Ø§Ù… (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…) ===== -->
  {% if stats.total_engineers > 0 %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† ÙˆØ§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</h5>
    </div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold">{{ stats.total_engineers }}</div>
            <div class="text-muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold text-success">{{ stats.active_engineers }}</div>
            <div class="text-muted small">Ù†Ø´Ø·</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold">{{ stats.total_open_tasks }}</div>
            <div class="text-muted small">Ù…Ù‡Ø§Ù… Ù…ÙØªÙˆØ­Ø©</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold text-danger">{{ stats.overdue_tasks_count }}</div>
            <div class="text-muted small">Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©</div>
          </div>
        </div>
      </div>

      {% if specialty_distribution %}
      <div class="mb-3">
        <strong>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ:</strong>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for name, count in specialty_distribution.items() %}
          <span class="badge bg-light text-dark border">{{ name }} <span class="ms-1 fw-semibold">{{ count }}</span></span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="row g-3">
        {% if upcoming_tasks %}
        <div class="col-lg-6">
          <div class="card bg-light border-0">
            <div class="card-header bg-white fw-semibold">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                {% for task in upcoming_tasks[:3] %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">
                    {{ task.engineer.name if task.engineer else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                    {% if task.deadline %} â€¢ {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}

        {% if overdue_tasks %}
        <div class="col-lg-6">
          <div class="card bg-light border-0">
            <div class="card-header bg-white fw-semibold text-danger">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                {% for task in overdue_tasks[:3] %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">
                    {{ task.engineer.name if task.engineer else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                    {% if task.deadline %} â€¢ ØªØ£Ø®Ø±Øª: {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
