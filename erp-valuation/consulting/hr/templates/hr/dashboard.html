{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- ===== العنوان والأزرار ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h3 class="mb-1">لوحة تحكم الموارد البشرية الشاملة</h3>
      <p class="text-muted mb-0 small">نظرة شاملة على جميع الأقسام والموظفين</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.list_employees') }}">قائمة الموظفين</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.list_engineers') }}">قائمة المهندسين</a>
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.create_employee') }}">➕ إضافة موظف جديد</a>
    </div>
  </div>

  <!-- ===== إحصائيات عامة ===== -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">إجمالي الموظفين</div>
        <div class="fs-3 fw-bold">{{ stats.total_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">الموظفون النشطون</div>
        <div class="fs-3 fw-bold text-success">{{ stats.active_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">في إجازة</div>
        <div class="fs-3 fw-bold text-warning">{{ stats.on_leave_employees }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">الحضور (هذا الشهر)</div>
        <div class="fs-3 fw-bold text-info">{{ stats.present_count }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">الغياب (هذا الشهر)</div>
        <div class="fs-3 fw-bold text-danger">{{ stats.absent_count }}</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">إجازات معلقة</div>
        <div class="fs-3 fw-bold">{{ stats.pending_leaves }}</div>
      </div>
    </div>
  </div>

  <!-- ===== إحصائيات الرواتب والمستندات ===== -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">كشوف الرواتب (هذا الشهر)</div>
        <div class="fs-4 fw-bold">{{ stats.current_month_payroll }}</div>
        {% if stats.total_payroll_amount > 0 %}
        <div class="text-muted small">إجمالي: {{ "{:,.0f}".format(stats.total_payroll_amount) }} ريال</div>
        {% endif %}
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">المستندات المنتهية</div>
        <div class="fs-4 fw-bold text-warning">{{ stats.expiring_documents }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">طلبات التوظيف</div>
        <div class="fs-4 fw-bold">{{ stats.pending_applications }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center p-3 h-100">
        <div class="text-muted small mb-1">إجمالي المهندسين</div>
        <div class="fs-4 fw-bold">{{ stats.total_engineers }}</div>
      </div>
    </div>
  </div>

  <!-- ===== توزيع الموظفين حسب الأقسام ===== -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">توزيع الموظفين حسب الأقسام</h5>
    </div>
    <div class="card-body">
      {% if department_distribution %}
        <div class="d-flex flex-wrap gap-3">
          {% for dept_name, count in department_distribution.items() %}
          <div class="text-center p-3 bg-light rounded">
            <div class="fs-4 fw-bold text-primary">{{ count }}</div>
            <div class="text-muted small">{{ dept_name }}</div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted text-center py-3">لا توجد أقسام مع موظفين حالياً</div>
      {% endif %}
    </div>
  </div>

  <!-- ===== إحصائيات كل قسم ===== -->
  {% if department_stats %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">إحصائيات مفصلة لكل قسم</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>القسم</th>
              <th class="text-center">إجمالي الموظفين</th>
              <th class="text-center">نشط</th>
              <th class="text-center">في إجازة</th>
              <th class="text-center">حاضر (هذا الشهر)</th>
              <th class="text-center">غائب (هذا الشهر)</th>
              <th class="text-center">إجازات معلقة</th>
            </tr>
          </thead>
          <tbody>
            {% for dept_stat in department_stats %}
            <tr>
              <td>
                <strong>{{ dept_stat.department.name }}</strong>
                {% if dept_stat.department.code %}
                <span class="text-muted small">({{ dept_stat.department.code }})</span>
                {% endif %}
              </td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ dept_stat.total_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-success">{{ dept_stat.active_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-warning text-dark">{{ dept_stat.on_leave_employees }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-info">{{ dept_stat.present_count }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-danger">{{ dept_stat.absent_count }}</span>
              </td>
              <td class="text-center">
                {% if dept_stat.pending_leaves > 0 %}
                <span class="badge bg-warning text-dark">{{ dept_stat.pending_leaves }}</span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== أحدث الموظفين والإجازات ===== -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">أحدث الموظفين المضافين</div>
        <div class="card-body">
          {% if recent_employees %}
          <ul class="list-group list-group-flush">
            {% for emp in recent_employees %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ emp.full_name }}</div>
                  <div class="text-muted small">
                    {% if emp.department %}{{ emp.department.name }} • {% endif %}
                    {% if emp.job_title %}{{ emp.job_title }}{% endif %}
                  </div>
                  {% if emp.created_at %}
                  <div class="text-muted small">{{ emp.created_at.strftime('%Y-%m-%d') }}</div>
                  {% endif %}
                </div>
                <span class="badge bg-{% if emp.status == 'نشط' %}success{% else %}secondary{% endif %}">
                  {{ emp.status }}
                </span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted text-center py-3">لا يوجد موظفون مضافون مؤخراً</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white fw-semibold">الإجازات القادمة</div>
        <div class="card-body">
          {% if upcoming_leaves %}
          <ul class="list-group list-group-flush">
            {% for leave in upcoming_leaves %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ leave.employee.full_name if leave.employee else 'غير محدد' }}</div>
                  <div class="text-muted small">
                    {% if leave.leave_type %}{{ leave.leave_type.name }} • {% endif %}
                    {{ leave.start_date.strftime('%Y-%m-%d') }} إلى {{ leave.end_date.strftime('%Y-%m-%d') }}
                  </div>
                  <div class="text-muted small">{{ leave.total_days }} يوم</div>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted text-center py-3">لا توجد إجازات قادمة</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== المستندات المنتهية ===== -->
  {% if docs_expiring_soon %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0 text-warning">⚠️ المستندات المنتهية قريباً (خلال 30 يوم)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>الموظف</th>
              <th>نوع المستند</th>
              <th>اسم المستند</th>
              <th>تاريخ الانتهاء</th>
              <th>الأيام المتبقية</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in docs_expiring_soon %}
            <tr>
              <td>{{ doc.employee.full_name if doc.employee else 'غير محدد' }}</td>
              <td>{{ doc.document_type }}</td>
              <td>{{ doc.document_name }}</td>
              <td>{{ doc.expiry_date.strftime('%Y-%m-%d') if doc.expiry_date else '-' }}</td>
              <td>
                {% set days = doc.days_until_expiry() %}
                {% if days is not none %}
                  {% if days < 0 %}
                  <span class="badge bg-danger">منتهي</span>
                  {% elif days <= 7 %}
                  <span class="badge bg-danger">{{ days }} يوم</span>
                  {% elif days <= 15 %}
                  <span class="badge bg-warning text-dark">{{ days }} يوم</span>
                  {% else %}
                  <span class="badge bg-info">{{ days }} يوم</span>
                  {% endif %}
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===== قسم المهندسين والمهام (للتوافق مع النظام القديم) ===== -->
  {% if stats.total_engineers > 0 %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white fw-semibold">
      <h5 class="mb-0">قسم المهندسين والاستشارات</h5>
    </div>
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold">{{ stats.total_engineers }}</div>
            <div class="text-muted small">إجمالي المهندسين</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold text-success">{{ stats.active_engineers }}</div>
            <div class="text-muted small">نشط</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold">{{ stats.total_open_tasks }}</div>
            <div class="text-muted small">مهام مفتوحة</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2 bg-light rounded">
            <div class="fs-5 fw-bold text-danger">{{ stats.overdue_tasks_count }}</div>
            <div class="text-muted small">مهام متأخرة</div>
          </div>
        </div>
      </div>

      {% if specialty_distribution %}
      <div class="mb-3">
        <strong>توزيع المهندسين حسب التخصص:</strong>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for name, count in specialty_distribution.items() %}
          <span class="badge bg-light text-dark border">{{ name }} <span class="ms-1 fw-semibold">{{ count }}</span></span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="row g-3">
        {% if upcoming_tasks %}
        <div class="col-lg-6">
          <div class="card bg-light border-0">
            <div class="card-header bg-white fw-semibold">المهام القادمة</div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                {% for task in upcoming_tasks[:3] %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">
                    {{ task.engineer.name if task.engineer else 'غير محدد' }}
                    {% if task.deadline %} • {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}

        {% if overdue_tasks %}
        <div class="col-lg-6">
          <div class="card bg-light border-0">
            <div class="card-header bg-white fw-semibold text-danger">المهام المتأخرة</div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                {% for task in overdue_tasks[:3] %}
                <li class="mb-2 pb-2 border-bottom">
                  <div class="fw-semibold">{{ task.title }}</div>
                  <div class="text-muted small">
                    {{ task.engineer.name if task.engineer else 'غير محدد' }}
                    {% if task.deadline %} • تأخرت: {{ task.deadline.strftime('%Y-%m-%d') }}{% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
