{% extends 'base.html' %}

{% block content %}
<style>
body {
  direction: rtl;
  text-align: right;
  font-family: 'Tajawal', sans-serif;
}
.container {
  max-width: 1200px;
  padding: 2rem 1rem;
}

/* Ø±Ø¤ÙˆØ³ Ø§Ù„ØµÙØ­Ø§Øª */
h3 {
  font-weight: 600;
  color: #4a148c;
}
.text-muted {
  font-size: 0.9rem;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.btn-primary, .btn-outline-secondary {
  border-radius: 8px;
  transition: 0.3s;
}
.btn-primary:hover { background-color: #5a32a3; }
.btn-outline-secondary:hover { background-color: #f8f9fa; color: #000; }

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù */
.card { border-radius: 10px; }
.card-body { padding: 1rem; }

/* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
.table thead { background-color: #f5f5f5; }
.table tbody tr:hover { background-color: #fdfcff; }
.badge { padding: 0.4em 0.6em; font-size: 0.85rem; border-radius: 0.5rem; }

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
.table-responsive { margin-bottom: 1rem; }
</style>

<div class="container py-4" data-expiring-count="{{ expiring_docs|length }}">
  
  {% if expiring_docs %}
  <div class="alert alert-warning mb-3">
    ØªÙ†Ø¨ÙŠÙ‡Ø§Øª: Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.
  </div>
  {% endif %}

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-3">
    <div>
      <h3>{{ employee.full_name }}</h3>
      <p class="text-muted small mb-0">
        {{ employee.job_title or employee.position or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
        {% if employee.department %} | {{ employee.department.name }}{% endif %}
      </p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.dashboard') }}">Ù„ÙˆØ­Ø© HR</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('consulting_hr.list_employees') }}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a>
      {% if can_manage %}
      <a class="btn btn-outline-primary" href="{{ url_for('manage_employees') }}">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
      <a class="btn btn-primary" href="{{ url_for('consulting_hr.edit_employee', employee_id=employee.id) }}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</a>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ -->
    <div class="col-lg-4 d-flex flex-column gap-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</h5>
          <dl class="row small mb-0">
            <dt class="col-5 text-muted">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</dt>
            <dd class="col-7">{{ employee.employee_number or '-' }}</dd>
            <dt class="col-5 text-muted">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ¸ÙŠÙ</dt>
            <dd class="col-7">{{ employee.employment_type or '-' }}</dd>
            <dt class="col-5 text-muted">Ø§Ù„Ù‚Ø³Ù…</dt>
            <dd class="col-7">{{ employee.department.name if employee.department else '-' }}</dd>
            <dt class="col-5 text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</dt>
            <dd class="col-7">{% if employee.join_date %}{{ employee.join_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</dd>
            <dt class="col-5 text-muted">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</dt>
            <dd class="col-7">{% if employee.contract_start_date %}{{ employee.contract_start_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</dd>
            <dt class="col-5 text-muted">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</dt>
            <dd class="col-7">{% if employee.contract_end_date %}{{ employee.contract_end_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</dd>
            <dt class="col-5 text-muted">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</dt>
            <dd class="col-7">{{ employee.base_salary or '-' }} {{ employee.currency or '' }}</dd>
            <dt class="col-5 text-muted">Ø§Ù„Ø­Ø§Ù„Ø©</dt>
            <dd class="col-7">
              <span class="badge {% if employee.status == 'Ù†Ø´Ø·' %}bg-success{% elif employee.status == 'Ø¥Ø¬Ø§Ø²Ø©' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ employee.status or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
            </dd>
          </dl>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h5>
          <ul class="list-unstyled small mb-0">
            <li><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> {{ employee.email or '-' }}</li>
            <li><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ employee.phone or '-' }}</li>
            <li><strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> {{ employee.mobile or '-' }}</li>
            <li><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ employee.address or '-' }}</li>
            <li><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> {{ employee.city or '-' }}</li>
            <li><strong>Ø§Ù„Ø¯ÙˆÙ„Ø©:</strong> {{ employee.country or '-' }}</li>
          </ul>
        </div>
      </div>

      {% if can_manage %}
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
          {% if employee.user_account %}
          <p class="small mb-1"><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> {{ employee.user_account.username }}</p>
          <p class="small mb-1"><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> {{ employee.user_account.role }}</p>
          {% if employee.user_account.branch %}
          <p class="small mb-3"><strong>Ø§Ù„ÙØ±Ø¹:</strong> {{ employee.user_account.branch.name }}</p>
          {% endif %}
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('manage_employees') }}">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</a>
          {% else %}
          <p class="text-muted small mb-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.</p>
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('manage_employees') }}">Ø¥Ù†Ø´Ø§Ø¡ / Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨</a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦</h5>
          {% if employee.emergency_contact_name or employee.emergency_contact_phone or employee.emergency_contact_relation %}
          <ul class="list-unstyled small mb-0">
            <li><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ employee.emergency_contact_name or '-' }}</li>
            <li><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ employee.emergency_contact_phone or '-' }}</li>
            <li><strong>ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©:</strong> {{ employee.emergency_contact_relation or '-' }}</li>
          </ul>
          {% else %}
          <p class="text-muted small mb-0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·ÙˆØ§Ø±Ø¦.</p>
          {% endif %}
        </div>
      </div>

      {% if employee.notes %}
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
          <p class="small mb-0">{{ employee.notes }}</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="col-lg-8 d-flex flex-column gap-3">
      <!-- Ø¨Ø·Ø§Ù‚Ø§Øª ØµØºÙŠØ±Ø© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card h-100 text-center">
            <div class="card-body">
              <p class="text-muted small mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
              <h5 class="mb-0">{% if employee.join_date %}{{ employee.join_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</h5>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 text-center">
            <div class="card-body">
              <p class="text-muted small mb-1">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ¸ÙŠÙ</p>
              <h5 class="mb-0">{{ employee.employment_type or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</h5>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 text-center">
            <div class="card-body">
              <p class="text-muted small mb-1">Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
              <h5 class="mb-0">{% if employee.leave_balances %}{{ employee.leave_balances | sum(attribute='remaining_balance') }} ÙŠÙˆÙ…{% else %}-{% endif %}</h5>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø¢Ø®Ø± Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
          <div class="table-responsive">
            <table class="table table-hover align-middle small">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                  <th>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                  <th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                </tr>
              </thead>
              <tbody>
                {% for att in recent_attendance %}
                <tr>
                  <td>{{ att.attendance_date.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <span class="badge {% if att.status == 'Ø­Ø§Ø¶Ø±' %}bg-success{% elif att.status == 'Ù…ØªØºÙŠØ¨' %}bg-danger{% elif att.status == 'Ø¥Ø¬Ø§Ø²Ø©' %}bg-info text-dark{% else %}bg-secondary{% endif %}">{{ att.status }}</span>
                  </td>
                  <td>{% if att.check_in %}{{ att.check_in.strftime('%H:%M') }}{% else %}-{% endif %}</td>
                  <td>{% if att.check_out %}{{ att.check_out.strftime('%H:%M') }}{% else %}-{% endif %}</td>
                  <td>{{ att.hours_worked or '-' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h5>
          <div class="table-responsive">
            <table class="table table-striped align-middle small">
              <thead>
                <tr>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                  <th>Ø§Ù„ÙØªØ±Ø©</th>
                  <th>Ø§Ù„Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody>
                {% for leave in recent_leaves %}
                <tr>
                  <td>{{ leave.leave_type.name if leave.leave_type else '-' }}</td>
                  <td>{{ leave.start_date.strftime('%Y-%m-%d') }} Ø¥Ù„Ù‰ {{ leave.end_date.strftime('%Y-%m-%d') }}</td>
                  <td>{{ leave.total_days }}</td>
                  <td>
                    <span class="badge {% if leave.status == 'Ù…ÙˆØ§ÙÙ‚' %}bg-success{% elif leave.status == 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' %}bg-warning text-dark{% elif leave.status == 'Ù…Ø±ÙÙˆØ¶' %}bg-danger{% else %}bg-secondary{% endif %}">{{ leave.status }}</span>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¬Ø§Ø²Ø§Øª.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</h5>
          <div class="table-responsive">
            <table class="table table-striped align-middle small">
              <thead>
                <tr>
                  <th>Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody>
                {% for doc in documents %}
                <tr class="{% if doc in expiring_docs %}table-danger{% endif %}">
                  <td>{{ doc.document_name }}</td>
                  <td>{{ doc.document_type }}</td>
                  <td>{% if doc.issue_date %}{{ doc.issue_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                  <td>{% if doc.expiry_date %}{{ doc.expiry_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                  <td>
                    {% if doc.is_expired() %}
                      <span class="badge bg-danger">Ù…Ù†ØªÙ‡ÙŠØ©</span>
                    {% elif doc.expiry_date %}
                      {% set days_left = doc.days_until_expiry() %}
                      {% if days_left is not none and days_left <= 30 %}
                        <span class="badge bg-warning text-dark">ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {{ days_left }} ÙŠÙˆÙ…</span>
                      {% else %}
                        <span class="badge bg-success">ØµØ§Ù„Ø­Ø©</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©</span>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ«Ø§Ø¦Ù‚.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.querySelector('.container[data-expiring-count]');
  const expiringCount = parseInt(container?.getAttribute('data-expiring-count') || '0', 10);
  if (expiringCount > 0) {
    const docNames = {{ expiring_docs | map(attribute='document_name') | list | tojson }};
    Swal.fire({
      icon: 'warning',
      title: 'ÙˆØ«Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡',
      text: expiringCount === 1
        ? `Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© "${docNames[0]}" Ø³ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ù‹Ø§.`
        : `Ù‡Ù†Ø§Ùƒ ${expiringCount} ÙˆØ«Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${docNames.join(', ')}`,
      confirmButtonText: 'ØªÙ…',
    });
  }
});
</script>
{% endblock %}
