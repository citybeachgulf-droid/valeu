"""
?????? ?????? ????? ?????? ???? ??????? ???????
Usage: python -m consulting.hr.init_hr_db
"""
import sys
import os

# ????? ???? ???????
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from app import app
from extensions import db
from consulting.hr.models import (
    Department, Employee, Attendance, SalaryComponent, Payroll, PayrollDetail,
    LeaveType, LeaveBalance, LeaveRequest, PerformanceReview, EmployeeGoal,
    TrainingProgram, TrainingParticipant, JobPosting, Candidate, JobApplication,
    Interview, EmployeeDocument, DocumentAlert
)

def init_hr_database():
    """????? ????? ????? ???????? ????? HR"""
    with app.app_context():
        print("????? ????? ????? ????????...")
        try:
            db.create_all()
            print("? ?? ????? ??????? ?????!")
            
            # ????? ????? ???????? ????????
            leave_types = [
                {"name": "????? ?????", "name_ar": "????? ?????", "code": "ANNUAL", "max_days": 30, "is_paid": True},
                {"name": "????? ?????", "name_ar": "????? ?????", "code": "SICK", "max_days": 15, "is_paid": True},
                {"name": "????? ???? ????", "name_ar": "????? ???? ????", "code": "UNPAID", "is_paid": False},
                {"name": "????? ?????", "name_ar": "????? ?????", "code": "MATERNITY", "max_days": 90, "is_paid": True},
                {"name": "????? ??????", "name_ar": "????? ??????", "code": "PATERNITY", "max_days": 7, "is_paid": True},
            ]
            
            for lt_data in leave_types:
                existing = LeaveType.query.filter_by(code=lt_data["code"]).first()
                if not existing:
                    leave_type = LeaveType(**lt_data)
                    db.session.add(leave_type)
            
            # ????? ?????? ?????? ????????
            salary_components = [
                {"name": "??? ?????", "name_ar": "??? ?????", "type": "allowance", "is_taxable": False},
                {"name": "??? ?????????", "name_ar": "??? ?????????", "type": "allowance", "is_taxable": False},
                {"name": "??? ??????", "name_ar": "??? ??????", "type": "allowance", "is_taxable": False},
                {"name": "????? ???", "name_ar": "????? ???", "type": "deduction", "is_taxable": False},
                {"name": "????? ???????", "name_ar": "????? ???????", "type": "deduction", "is_taxable": False},
                {"name": "?????", "name_ar": "?????", "type": "deduction", "is_taxable": False},
                {"name": "???", "name_ar": "???", "type": "deduction", "is_taxable": False},
                {"name": "??????", "name_ar": "??????", "type": "bonus", "is_taxable": True},
            ]
            
            for sc_data in salary_components:
                existing = SalaryComponent.query.filter_by(name=sc_data["name"]).first()
                if not existing:
                    component = SalaryComponent(**sc_data)
                    db.session.add(component)
            
            db.session.commit()
            print("? ?? ????? ????? ???????? ??????? ?????? ????????!")
            
            print("\n? ?? ????? ????? ?????? ???? ??????? ??????? ?????!")
            
        except Exception as e:
            print(f"? ??? ?? ????? ????? ????????: {e}")
            db.session.rollback()
            raise

if __name__ == "__main__":
    init_hr_database()
